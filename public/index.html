<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zaharia Media — Dashboard</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://i.imgur.com/wbo6pQz.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand1: #fd513a; /* orange */
      --brand2: #9f5281; /* purple */
      --brand3: #2c53d8; /* blue */
    }
    body{
      background: radial-gradient(1000px 600px at 20% 10%, rgba(253,81,58,.24), transparent 60%),
                  radial-gradient(900px 520px at 85% 0%, rgba(159,82,129,.22), transparent 60%),
                  radial-gradient(1200px 700px at 50% 110%, rgba(44,83,216,.25), transparent 58%),
                  #0a0a0f;
      color: #f3f4f6;
      background-attachment: fixed;
      overflow-y: overlay;
    }
    @keyframes floaty { 0%{transform:translateY(0)} 50%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
    .glass{ backdrop-filter: blur(16px); background: rgba(18,18,24,.55); border: 1px solid rgba(255,255,255,.10); }
    .tile{ transition: transform .18s ease, box-shadow .18s ease; }
    .tile:hover{ transform: translateY(-4px) scale(1.03); box-shadow: 0 24px 70px rgba(0,0,0,.35); }
    .btn-brand{ background-image: linear-gradient(90deg, var(--brand1), var(--brand2), var(--brand3)); transition: transform .15s ease, filter .15s ease; }
    .btn-brand:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn-ghost{ position: relative; }
    .btn-ghost::after{
      content:""; position:absolute; inset:0; border-radius:inherit;
      padding:1px; background: linear-gradient(90deg, var(--brand1), var(--brand2), var(--brand3));
      -webkit-mask: 
        linear-gradient(#000 0 0) content-box, 
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      box-shadow: 0 6px 30px rgba(0,0,0,.35);
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; word-break: break-all; }
    .tab{ border-bottom: 2px solid transparent; padding: .5rem .75rem; border-radius: .5rem .5rem 0 0; cursor:pointer }
    .tab.active{ border-color: rgba(255,255,255,.12); background: rgba(255,255,255,.05); }

    .dropdown{ position: relative; }
    .dropdown-menu{ position: absolute; right: 0; top: calc(100% + .5rem); min-width: 12rem; display: none; z-index: 50; }
    .dropdown.open .dropdown-menu{ display: block; }
    .avatar{
      height: 36px; width: 36px; border-radius: 9999px; display: inline-flex; align-items:center; justify-content:center; font-weight:700;
      background: linear-gradient(135deg, rgba(253,81,58,.9), rgba(44,83,216,.85));
      color: white; box-shadow: 0 2px 18px rgba(0,0,0,.35);
    }

    #toasts { position: fixed; right: 1rem; bottom: 1rem; display: flex; flex-direction: column; gap: .5rem; z-index: 60; }
    .toast { padding: .6rem .8rem; border-radius: .75rem; font-size: .9rem; }
    .toast-ok { background: rgba(34,197,94,.16); color: #bbf7d0; border: 1px solid rgba(34,197,94,.3); }
    .toast-err { background: rgba(239,68,68,.16); color: #fecaca; border: 1px solid rgba(239,68,68,.3); }

    .qr-box{ display:flex; gap:16px; align-items:flex-start; }
    .qr canvas{ width:240px !important; height:240px !important; image-rendering:pixelated; }

    .bar{ width: 100%; border-radius: 9999px; background: rgba(255,255,255,.08); overflow: hidden; position: relative; }
    .bar > span{ display:block; height:100%; background-image: linear-gradient(90deg, var(--brand1), var(--brand2), var(--brand3)); }

    /* Keep queue columns fixed so headers don't shift when empty */
    .table-fixed { table-layout: fixed; width: 100%; }
    .queue-table th:nth-child(1), .queue-table td:nth-child(1) { width: 40%; }
    .queue-table th:nth-child(2), .queue-table td:nth-child(2) { width: 15%; }
    .queue-table th:nth-child(3), .queue-table td:nth-child(3) { width: 30%; }
    .queue-table th:nth-child(4), .queue-table td:nth-child(4) { width: 15%; }

    /* ================================ */
    /*  Global pill toggles (checkbox)  */
    /* ================================ */
    input[type="checkbox"]{
      -webkit-appearance: none; appearance: none;
      width: 44px; height: 24px; border-radius: 9999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.2);
      position: relative; cursor: pointer; outline: none;
      transition: background .25s ease, border-color .25s ease, box-shadow .25s ease;
      vertical-align: middle; flex-shrink: 0;
    }
    input[type="checkbox"]::after{
      content: ""; position: absolute; top: 1.5px; left: 1.5px;
      width: 20px; height: 20px; border-radius: 9999px; background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.35);
      transition: transform .25s ease;
    }
    input[type="checkbox"]:checked{
      background-image: linear-gradient(90deg, var(--brand1), var(--brand2), var(--brand3));
      border-color: transparent;
    }
    input[type="checkbox"]:checked::after{ transform: translateX(20px); }
    input[type="checkbox"]:focus-visible{ box-shadow: 0 0 0 3px rgba(44,83,216,.35); }
    input[type="checkbox"][disabled]{ opacity:.6; cursor:not-allowed; }
    @media (prefers-reduced-motion: reduce){
      input[type="checkbox"], input[type="checkbox"]::after{ transition: none; }
    }

    /* Admin Apps editor layout helpers */
    .apps-grid{ display:grid; grid-template-columns: repeat(1,minmax(0,1fr)); gap: .75rem; }
    @media (min-width:768px){ .apps-grid{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (min-width:1280px){ .apps-grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
    .app-card{ display:flex; flex-direction:column; height:100%; }
  </style>
</head>
<body class="h-full">
  <div id="toasts"></div>

  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="p-6 flex items-center justify-between gap-3 sm:gap-6 flex-wrap">
      <a id="brandLink" href="#" class="flex items-center gap-3 sm:gap-4 animate-[floaty_6s_ease-in-out_infinite]">
        <img id="brandLogo" src="https://i.imgur.com/zzRKKsM.png" alt="Zaharia Media" class="h-8 sm:h-10 w-auto rounded" />
        <h1 class="hidden sm:block text-2xl font-semibold tracking-tight">Dashboard</h1>
      </a>
      <nav id="navArea" class="hidden shrink-0 gap-3 items-center">
        <div id="userMenu" class="dropdown">
          <button id="userBtn" class="flex items-center gap-2">
            <span id="userName" class="text-sm font-medium"></span>
            <img id="userAvatar" class="h-9 w-9 rounded-full object-cover hidden" alt="avatar"/>
            <span id="userInitial" class="avatar"></span>
          </button>
          <div class="dropdown-menu glass rounded-xl p-2 shadow-xl">
            <button id="ddSettings" class="block w-full text-left px-3 py-2 rounded hover:bg-white/10">User Settings</button>
            <button id="ddAdmin" class="hidden w-full text-left px-3 py-2 rounded hover:bg-white/10">Admin</button>
            <button id="ddLogout" class="block w-full text-left px-3 py-2 rounded hover:bg-white/10">Logout</button>
          </div>
        </div>
      </nav>
    </header>

    <main class="flex-1 p-6">
      <!-- Login View -->
      <section id="view-login" class="max-w-md mx-auto glass rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-4">Sign in</h2>
        <form id="loginForm" class="space-y-3" method="post">
          <input name="username" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="Username" required />
          <input name="password" type="password" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="Password" required />
          <label class="flex items-center gap-2 text-sm select-none">
            <input type="checkbox" name="remember" /> <span>Remember me</span>
          </label>
          <div id="otpWrap" class="hidden space-y-1">
            <input name="otp" class="w-full px-3 py-2 rounded bg-white/5 border border-white/10" placeholder="One-time code" />
            <p id="otpHint" class="text-xs text-neutral-300">MFA required. Enter your 6-digit code.</p>
          </div>
          <button type="submit" class="w-full py-2 rounded btn-brand text-white font-semibold">Login</button>
          <div id="loginError" class="text-sm text-red-300 mt-2"></div>
        </form>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
          <button type="button" id="btn-register" class="btn-ghost w-full group flex items-center justify-center gap-2 px-3 py-2 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-80 group-hover:opacity-100" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8.5c0-.8-.4-1.5-1.1-1.9l-6.8-3.9c-.7-.4-1.5-.4-2.2 0L4.1 6.6C3.4 7 3 7.7 3 8.5v7c0 .8.4 1.5 1.1 1.9l6.8 3.9c.7.4 1.5.4 2.2 0l6.8-3.9c.7-.4 1.1-1.1 1.1-1.9v-7ZM12 7a1 1 0 0 1 1 1v2h2a1 1 0 1 1 0 2h-2v2a1 1 0 1 1-2 0v-2H9a1 1 0 1 1 0-2h2V8a1 1 0 0 1 1-1Z"/></svg>
            <span>Have an invite code?</span>
          </button>
          <button type="button" id="btn-reset" class="btn-ghost w-full group flex items-center justify-center gap-2 px-3 py-2 rounded-lg border border-white/15 bg-white/5 hover:bg-white/10 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-80 group-hover:opacity-100" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10 1 1 0 0 0-2 0 8 8 0 1 1-8-8 1 1 0 0 0 0-2Zm1 6a1 1 0 0 0-2 0v3.59l-1.3 1.3a1 1 0 1 0 1.4 1.42l1.6-1.6A1 1 0 0 0 13 12Z"/></svg>
            <span>Have a recovery code?</span>
          </button>
        </div>
      </section>

      <!-- Register View -->
      <section id="view-register" class="hidden max-w-md mx-auto glass rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-4">Create account</h2>
        <form id="registerForm" class="space-y-3" method="post">
          <input name="inviteCode" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="Invite code" required />
          <input name="username" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="Username" required />
          <input name="password" type="password" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="Password" required />
          <label class="flex items-center gap-2 text-sm select-none">
            <input type="checkbox" name="enableTotp" /> <span>Enable one-time passcode (TOTP)</span>
          </label>
          <button type="submit" class="w-full py-2 rounded btn-brand text-white font-semibold">Register</button>
        </form>

        <div id="registerMfa" class="hidden mt-5 text-sm">
          <div class="qr-box">
            <div id="qr" class="qr bg-white p-2 rounded inline-block"></div>
            <div class="space-y-2">
              <div>
                <div class="text-neutral-300">Setup link (otpauth)</div>
                <div id="otpauth" class="mono bg-white/5 border border-white/10 rounded p-2 max-w-[520px]"></div>
                <button type="button" id="copyOtpauth" class="mt-2 px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-xs">Copy setup link</button>
              </div>
              <div>
                <div class="text-neutral-300">Secret</div>
                <div id="otpsecret" class="mono bg-white/5 border border-white/10 rounded p-2 inline-block"></div>
                <button type="button" id="copySecret" class="mt-2 px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-xs">Copy secret</button>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-xs mb-1">Enter 6-digit code from your app</label>
            <input id="registerOtp" class="w-48 px-2 py-2 rounded bg-white/5 border" placeholder="123456" inputmode="numeric" maxlength="6" />
          </div>
          <button type="button" id="registerVerify" class="mt-3 px-4 py-2 btn-brand text-white rounded">Save & Register</button>
        </div>

        <div class="mt-4"><button type="button" id="btn-register-back" class="underline">Back to sign in</button></div>
      </section>

      <!-- Reset View -->
      <section id="view-reset" class="hidden max-w-md mx-auto glass rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-4">Reset password</h2>
        <form id="resetForm" class="space-y-3" method="post">
          <input name="code" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="Admin-provided recovery code" required />
          <input name="password" type="password" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="New password" required />
          <button type="submit" class="w-full py-2 rounded btn-brand text-white font-semibold">Reset</button>
        </form>
        <div class="mt-4"><button type="button" id="btn-reset-back" class="underline">Back to sign in</button></div>
      </section>

      <!-- App Dashboard View -->
      <section id="view-apps" class="hidden">

        <!-- NOW PLAYING (Admins only, per-admin toggle) -->
        <div id="nowPlayingWrap" class="glass rounded-2xl p-4 mb-6 hidden">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Now Playing (Plex)</h3>
            <div class="text-xs text-neutral-300" id="npMeta"></div>
          </div>
          <div id="nowPlaying"></div>
        </div>

        <!-- Download Queue Widget -->
        <div class="glass rounded-2xl p-4 mb-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Download Queue</h3>
            <div class="text-xs text-neutral-300" id="sabStatus"></div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm table-fixed queue-table">
              <thead class="text-neutral-300">
                <tr>
                  <th class="text-left py-2">Filename</th>
                  <th class="text-left">Status</th>
                  <th class="text-left">Download Progress</th>
                  <th class="text-right">Time left</th>
                </tr>
              </thead>
              <tbody id="sabRows"></tbody>
            </table>
          </div>
          <div class="flex justify-end items-center gap-2 mt-2 text-sm">
            <button type="button" id="sabPrev" class="px-2 py-1 rounded bg-white/10">Prev</button>
            <span id="sabPage"></span>
            <button type="button" id="sabNext" class="px-2 py-1 rounded bg-white/10">Next</button>
          </div>
        </div>

        <!-- Tiles -->
        <div id="tiles" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
      </section>

      <!-- Admin Panel (Tabbed) -->
      <section id="view-admin" class="hidden glass rounded-2xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold mb-3">Admin</h2>
          <button type="button" id="btn-admin-close" class="underline">Close Admin</button>
        </div>

        <div class="mt-2 flex gap-2 border-b border-white/10 pb-2">
          <button class="tab active" data-tab="apps">Apps</button>
          <button class="tab" data-tab="users">Users</button>
          <button class="tab" data-tab="invites">Invites</button>
        </div>

        <!-- TAB: Apps -->
        <div id="tab-apps" class="pt-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Applications</h3>
            <button id="addApp" class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-sm">+ Add App</button>
          </div>
          <!-- symmetrical grid with logo previews & delete buttons -->
          <div id="appsEditor" class="apps-grid"></div>
          <div class="mt-3 flex gap-2">
            <button id="saveApps" class="px-4 py-2 btn-brand text-white rounded">Save Apps</button>
          </div>

          <h3 class="font-semibold mt-8 mb-2">SABnzbd Settings</h3>
          <div class="space-y-2 max-w-xl">
            <input id="sabBaseUrl" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="Base URL (e.g., https://sab.zahariamedia.ca/)" />
            <input id="sabApiKey" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="API Key" />
            <div class="flex gap-2">
              <button id="saveSab" class="px-4 py-2 btn-brand text-white rounded">Save SAB Settings</button>
              <button id="testSab" class="px-4 py-2 bg-white/10 border border-white/10 rounded">Test connection</button>
            </div>
          </div>

          <h3 class="font-semibold mt-8 mb-2">Plex Settings</h3>
          <div class="space-y-2 max-w-xl">
            <input id="plexBaseUrl" class="w-full px-3 py-2 rounded bg-white/5 border"
                   placeholder="Plex Base URL (e.g., http://192.168.1.182:32400)" />
            <input id="plexToken" class="w-full px-3 py-2 rounded bg-white/5 border"
                   placeholder="Plex Token (X-Plex-Token)" />
            <div class="flex gap-2">
              <button id="savePlex" class="px-4 py-2 btn-brand text-white rounded">Save Plex Settings</button>
              <button id="testPlex" class="px-4 py-2 bg-white/10 border border-white/10 rounded">Test connection</button>
            </div>
          </div>

        </div>

        <!-- TAB: Users -->
        <div id="tab-users" class="pt-4 hidden">
          <h3 class="font-semibold mb-2">Users</h3>
          <div id="usersList" class="space-y-2"></div>
        </div>

        <!-- TAB: Invites -->
        <div id="tab-invites" class="pt-4 hidden">
          <h3 class="font-semibold mb-2">Invites</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end max-w-3xl">
            <div>
              <label class="block text-xs mb-1">Role</label>
              <select id="invRole" class="px-3 py-2 rounded bg-white/5 border w-full">
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-xs mb-1">Expires</label>
              <select id="invPreset" class="px-3 py-2 rounded bg-white/5 border w-full">
                <option value="1d">1 day</option>
                <option value="7d">7 days</option>
                <option value="1m">1 month</option>
                <option value="6m">6 months</option>
                <option value="never">Never</option>
              </select>
            </div>
            <div>
              <button id="invCreate" class="px-4 py-2 btn-brand text-white rounded w-full">Create Invite</button>
            </div>
          </div>

          <div class="mt-3 overflow-x-auto" id="invList"></div>

          <div class="mt-4 flex gap-2">
            <button id="eraseUsedInvites" class="px-3 py-1.5 rounded bg-white/10">Erase USED</button>
            <button id="eraseAllInvites" class="px-3 py-1.5 rounded bg-red-700/80">Erase ALL</button>
          </div>
        </div>
      </section>

      <!-- User Settings Panel -->
      <section id="view-settings" class="hidden glass rounded-2xl p-6 max-w-xl mx-auto">
        <h2 class="text-xl font-semibold mb-3">User Settings</h2>
        <form id="meForm" class="space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input name="username" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="New username (optional)" />
            <input name="password" type="password" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="New password (optional)" />
            <input name="firstName" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="First name" />
            <input name="lastName" class="w-full px-3 py-2 rounded bg-white/5 border" placeholder="Last name" />
          </div>
          <div>
            <label class="block text-sm mb-1">Profile picture</label>
            <input id="pfp" type="file" accept="image/*" class="text-sm" />
          </div>

          <!-- Admin-only preference -->
          <div id="prefNPRow" class="hidden">
            <label class="flex items-center gap-2 text-sm select-none">
              <input type="checkbox" id="prefShowNP" />
              <span>Show Now Playing card</span>
            </label>
          </div>

          <!-- MFA (Authenticator App) -->
          <div id="mfaBox" class="rounded-xl border border-white/10 p-3 bg-white/5">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-semibold">Authenticator App (TOTP)</div>
                <div id="mfaStatus" class="text-sm text-neutral-300">Checking…</div>
              </div>
              <div class="flex gap-2">
                <button type="button" id="mfaStart" class="px-3 py-1.5 rounded bg-white/10 hidden">Set up</button>
                <button type="button" id="mfaDisable" class="px-3 py-1.5 rounded bg-red-700/80 hidden">Disable</button>
              </div>
            </div>
            <div id="mfaSetup" class="hidden mt-3">
              <div class="qr-box">
                <div id="mfaQr" class="qr bg-white p-2 rounded inline-block"></div>
                <div class="space-y-2">
                  <div>
                    <div class="text-neutral-300">Setup link (otpauth)</div>
                    <div id="mfaOtpauth" class="mono bg-white/5 border border-white/10 rounded p-2 max-w-[520px]"></div>
                    <button type="button" id="mfaCopyLink" class="mt-2 px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-xs">Copy setup link</button>
                  </div>
                  <div>
                    <div class="text-neutral-300">Secret</div>
                    <div id="mfaSecret" class="mono bg-white/5 border border-white/10 rounded p-2 inline-block"></div>
                    <button type="button" id="mfaCopySecret" class="mt-2 px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-xs">Copy secret</button>
                  </div>
                  <div class="mt-2">
                    <label class="block text-xs mb-1">Enter 6‑digit code from your app</label>
                    <input id="mfaCode" class="w-48 px-2 py-2 rounded bg-white/5 border" placeholder="123456" inputmode="numeric" maxlength="6" />
                  </div>
                  <button type="button" id="mfaVerify" class="px-4 py-2 btn-brand text-white rounded">Verify & Save</button>
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 py-2 rounded btn-brand text-white font-semibold">Save</button>
            <button type="button" id="btn-settings-close" class="px-4 rounded bg-white/10">Close</button>
          </div>
        </form>
      </section>
    </main>

    <footer class="p-6 text-xs text-neutral-300 text-center">© <span id="year"></span> Zaharia Media. All rights reserved.</footer>
  </div>

  <!-- Simple modal (used by reset codes, etc.) -->
  <div id="modal" class="fixed inset-0 bg-black/60 hidden z-50">
    <div class="max-w-lg mx-auto mt-24 glass rounded-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div id="modalTitle" class="font-semibold"></div>
        <button id="modalCancel" class="px-3 py-1 bg-white/10 rounded">Close</button>
      </div>
      <div id="modalBody" class="text-sm"></div>
      <div class="mt-3 flex justify-end gap-2">
        <button id="modalOk" class="px-3 py-1.5 btn-brand text-white rounded">Confirm</button>
      </div>
    </div>
  </div>

  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    const S = { token: null, me: null, sabPage: 1, sabPages: 1, sabTimer: null, npTimer: null, apps: [] };
    const $ = sel => document.querySelector(sel);

    function clearUrlParams(){ try { if (history.replaceState) history.replaceState(null, '', location.pathname); } catch {}
    }

    function toast(msg, kind='ok'){
      const wrap = $('#toasts'); const div = document.createElement('div');
      div.className = `toast ${kind==='ok'?'toast-ok':'toast-err'}`; div.textContent = msg;
      wrap.appendChild(div); setTimeout(()=> div.remove(), 3500);
    }

    // Modal helper
    const Modal = {
      open({ title, bodyHTML, confirmText='Confirm', onConfirm, onOpen }){
        $('#modalTitle').textContent = title || '';
        $('#modalBody').innerHTML = bodyHTML || '';
        $('#modalOk').textContent = confirmText;
        $('#modal').classList.remove('hidden');
        onOpen && onOpen();
        const ok = $('#modalOk'), cancel = $('#modalCancel');
        const close = ()=> $('#modal').classList.add('hidden');
        cancel.onclick = close;
        ok.onclick = async ()=>{ try{ await onConfirm?.(); } finally { close(); } };
      }
    };

    function show(id){
      for (const s of ["#view-login","#view-register","#view-reset","#view-apps","#view-admin","#view-settings"]) {
        const el = $(s); if (el) el.classList.add("hidden");
      }
      const tgt = $(id); if (tgt) tgt.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Time helpers
    function fmtTime(sec){ if (sec==null||!isFinite(sec)) return '0:00'; sec=Math.max(0,Math.floor(sec)); const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=sec%60; return (h?`${h}:${String(m).padStart(2,'0')}`:`${m}`)+`:${String(s).padStart(2,'0')}`; }

    async function api(path, opts = {}){
      const res = await fetch(path, Object.assign({ headers: { 'Content-Type':'application/json', ...(S.token? { Authorization: 'Bearer '+S.token }:{}) } }, opts));
      const ct = res.headers.get('content-type') || ''; const text = await res.text(); let data;
      if (ct.includes('application/json')){ try{ data = JSON.parse(text); }catch{ throw { error:'Invalid JSON from server', raw:text }; } }
      else { throw { error: `Bad response (${res.status})`, body: text.slice(0,200) }; }
      if (!res.ok) throw data; return data;
    }

    // Brand click
    $('#brandLink').onclick = (e)=>{ e.preventDefault(); if (S.token) show('#view-apps'); else show('#view-login'); };

    // Tabs
    document.addEventListener('click', (e)=>{ const t=e.target.closest('.tab'); if(!t) return; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const k=t.dataset.tab; ['apps','users','invites'].forEach(name=> $('#tab-'+name)?.classList.toggle('hidden', name!==k)); });

    function renderQRTo(container, text){
      const box=$(container); if(!box) return;
      box.innerHTML="";
      const c=document.createElement("canvas");
      c.width=240; c.height=240;
      box.appendChild(c);
      QRCode.toCanvas(
        c,
        text,
        { width:240, margin:1, color:{ dark:'#000', light:'#fff' } },
        err=>{ if(err) console.error(err); }
      );
    }

    async function copyToClipboard(t){ try{ await navigator.clipboard.writeText(t); }catch{ const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove(); } toast('Copied to clipboard'); }

    // Bootstrap token
    (function(){ const saved=localStorage.getItem('zm_token'); if(saved){ S.token=saved; api('/api/me').then(me=>{ S.me=me.user; clearUrlParams(); afterLogin(false); }).catch(()=>{ localStorage.removeItem('zm_token'); S.token=null; }); } })();

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const errBox=$('#loginError'); if(errBox) errBox.textContent='';
      const fd=new FormData(e.target); const remember=!!fd.get('remember'); const body={ username:fd.get('username'), password:fd.get('password'), remember };
      const otp=fd.get('otp'); if(otp) body.otp=otp;
      try{ const { token, user } = await api('/api/login',{ method:'POST', body: JSON.stringify(body) }); S.token=token; S.me=user; if(remember) localStorage.setItem('zm_token', token); else localStorage.removeItem('zm_token'); clearUrlParams(); afterLogin(); }
      catch(err){ if(err && err.error==='MFA code required'){ const w=$('#otpWrap'); if(w){ w.classList.remove('hidden'); w.querySelector('input[name="otp"]').focus(); } return; } (errBox||{}).textContent = (err && (err.error||err.message)) ? (err.error||err.message) : 'Login failed'; }
    });
    $('#btn-register').onclick = (e)=>{ e.preventDefault(); show('#view-register'); };
    $('#btn-reset').onclick    = (e)=>{ e.preventDefault(); show('#view-reset'); };

    // Register
    document.getElementById('registerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const username=fd.get('username');
      const password=fd.get('password');
      const body={ inviteCode:fd.get('inviteCode'), username, password, enableTotp:!!fd.get('enableTotp') };
      try{
        const { otpauth, secret } = await api('/api/register', { method:'POST', body: JSON.stringify(body) });
        if(otpauth){
          const sec = secret || (()=>{ try{ const u=new URL(otpauth); return new URLSearchParams(u.search).get('secret')||''; }catch{} return ''; })();
          e.target.classList.add('hidden');
          const wrap=$('#registerMfa');
          wrap.classList.remove('hidden');
          renderQRTo('#qr', otpauth);
          $('#otpauth').textContent=otpauth;
          $('#otpsecret').textContent=sec;
          $('#copyOtpauth').onclick=()=>copyToClipboard(otpauth);
          $('#copySecret').onclick=()=>copyToClipboard(sec);
          const otpInput=$('#registerOtp');
          $('#registerVerify').onclick=async ()=>{
            const code=(otpInput.value||'').trim();
            if(!/^[0-9]{6}$/.test(code)) return toast('Enter a valid 6-digit code','err');
            try{
              const { token, user } = await api('/api/login',{ method:'POST', body: JSON.stringify({ username, password, otp: code }) });
              S.token=token; S.me=user; localStorage.setItem('zm_token', token);
              clearUrlParams();
              toast('Account created!');
              afterLogin();
            }catch(err){ toast(err.error||'Verification failed','err'); }
          };
        } else {
          toast('Account created! You can now sign in.');
          show('#view-login');
        }
      } catch(err){
        toast(err.error||'Registration failed','err');
      }
    });
    $('#btn-register-back').onclick = (e)=>{ e.preventDefault(); show('#view-login'); };

    // Reset
    document.getElementById('resetForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const fd=new FormData(e.target);
      try{ await api('/api/reset', { method:'POST', body: JSON.stringify({ code: fd.get('code'), newPassword: fd.get('password') }) }); toast('Password updated. Sign in.'); show('#view-login'); }
      catch(err){ toast(err.error||'Reset failed','err'); }
    });
    $('#btn-reset-back').onclick = (e)=>{ e.preventDefault(); show('#view-login'); };

    function initialsFor(u){ const fn=(u.firstName||'').trim(); const ln=(u.lastName||'').trim(); const un=(u.username||'').trim(); if(fn||ln){ return ((fn[0]||'')+(ln[0]||'')).toUpperCase() || (un[0]||'?').toUpperCase(); } return (un[0]||'?').toUpperCase(); }

    async function afterLogin(skipShow){
      const me = S.me || (await api('/api/me')).user; S.me = me;

      // Header user menu
      $('#navArea').classList.remove('hidden');
      const displayName = [S.me.firstName, S.me.lastName].filter(Boolean).join(' ') || S.me.username || '';
      $('#userName').textContent = displayName;
      const ua=$('#userAvatar'), ui=$('#userInitial');
      if (S.me.profileImage){ ua.src=S.me.profileImage; ua.classList.remove('hidden'); ui.classList.add('hidden'); }
      else { ui.textContent = initialsFor(S.me); ui.classList.remove('hidden'); ua.classList.add('hidden'); }
      if (S.me.role === 'admin') $('#ddAdmin').classList.remove('hidden');

      // Dropdown behavior
      const dd=$('#userMenu'); const btn=$('#userBtn');
      btn.onclick = (e)=>{ e.preventDefault(); dd.classList.toggle('open'); };
      document.addEventListener('click', (e)=>{ if (!dd.contains(e.target)) dd.classList.remove('open'); });
      $('#ddSettings').onclick = ()=>{ populateMeForm(); show('#view-settings'); dd.classList.remove('open'); };
      $('#ddAdmin').onclick = ()=>{ show('#view-admin'); dd.classList.remove('open'); };
      $('#ddLogout').onclick = async ()=>{ await api('/api/logout',{ method:'POST' }); localStorage.removeItem('zm_token'); location.reload(); };

      // Admin-only pref toggle visibility & state
      const prefRow=$('#prefNPRow'); const prefCb=$('#prefShowNP');
      if (S.me.role === 'admin'){ 
        prefRow.classList.remove('hidden');
        const showNP = (S.me.preferences && 'showNowPlaying' in S.me.preferences) ? !!S.me.preferences.showNowPlaying : true;
        prefCb.checked = showNP;
      } else { prefRow.classList.add('hidden'); }

      await loadApps();
      renderTiles();
      S.sabPage = 1; startSabPolling();
      startNowPlayingPolling();
      setupMfaUI();

      if (!skipShow) show('#view-apps');
    }

    // ----- Per-user app order helpers -----
    function applyAppOrder(apps, order){ if(!Array.isArray(order)||!order.length) return apps.slice(); const index=new Map(order.map((k,i)=>[k,i])); return apps.slice().sort((a,b)=>{ const ai=index.has(a.key)?index.get(a.key):Infinity; const bi=index.has(b.key)?index.get(b.key):Infinity; if(ai!==bi) return ai-bi; return (a.name||'').localeCompare(b.name||''); }); }
    async function saveAppOrder(order){ try{ await api('/api/me', { method:'PUT', body: JSON.stringify({ appOrder: order }) }); S.me.preferences=S.me.preferences||{}; S.me.preferences.appOrder=order.slice(); toast('App order saved'); }catch(e){ toast(e.error||'Failed to save order','err'); } }

    async function loadApps(){
      const { apps } = await api('/api/apps');
      const visible = (S.me.role === 'admin') ? apps : apps.filter(a => !a.hidden && !a._hidden);
      const order = (S.me.preferences && Array.isArray(S.me.preferences.appOrder)) ? S.me.preferences.appOrder : [];
      S.apps = applyAppOrder(visible, order);

      if (S.me.role === 'admin'){
        const wrap = $('#appsEditor');
        if (wrap){
          const renderEditor = (list)=>{
            wrap.className='apps-grid'; wrap.innerHTML='';
            for(const a of list){
              const row=document.createElement('div');
              row.className='app-card rounded-xl bg-white/5 border border-white/10 p-3';
              row.innerHTML = `
                <div class="flex items-center justify-between gap-3">
                  <div class="flex items-center gap-3 min-w-0">
                    <img id="logoPreview-${a.key}" src="${a.logo||''}" onerror="this.src='';this.classList.add('opacity-40');" class="h-10 w-10 object-contain rounded bg-white/10 p-1" alt="logo" />
                    <div class="min-w-0">
                      <div class="text-base font-semibold truncate">${a.name || '(unnamed app)'}</div>
                      <div class="text-xs text-neutral-300 truncate">${a.url || ''}</div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <label class="text-xs flex items-center gap-2 select-none">
                      <input data-k="hidden" data-key="${a.key}" type="checkbox" ${a.hidden?'checked':''}/>
                      <span>Hide</span>
                    </label>
                    <button class="px-2 py-1 bg-red-700/80 rounded text-xs" data-del="${a.key}">Delete</button>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                  <div>
                    <label class="block text-xs mb-1">Name</label>
                    <input data-k="name" data-key="${a.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${a.name||''}">
                  </div>
                  <div>
                    <label class="block text-xs mb-1">App URL</label>
                    <input data-k="url" data-key="${a.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${a.url||''}">
                  </div>
                  <div>
                    <label class="block text-xs mb-1">Logo URL</label>
                    <input data-k="logo" data-key="${a.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${a.logo||''}">
                  </div>
                </div>`;
              wrap.appendChild(row);
            }

            // Live logo preview
            wrap.querySelectorAll('input[data-k="logo"]').forEach(inp=>{
              inp.addEventListener('input', (e)=>{ const key=e.target.getAttribute('data-key'); const img=document.getElementById('logoPreview-'+key); if(img) img.src=e.target.value.trim(); });
            });

            // Delete buttons (delegated)
            wrap.querySelectorAll('button[data-del]').forEach(btn=>{
              btn.onclick = ()=>{
                const id = btn.getAttribute('data-del');
                const nameInput = wrap.querySelector(`input[data-k="name"][data-key="${id}"]`);
                const appName = nameInput?.value?.trim() || '';
                Modal.open({
                  title: 'Delete App',
                  bodyHTML: 'Are you sure you want to delete "<span id="delAppName"></span>"?',
                  confirmText: 'Delete',
                  onOpen: ()=>{ $('#delAppName').textContent = appName; },
                  onConfirm: async ()=>{
                    try {
                      await api('/api/apps/'+encodeURIComponent(id), { method:'DELETE' });
                      toast('App deleted');
                      await loadApps();
                      renderTiles();
                    } catch(e){
                      toast(e.error||'Delete failed','err');
                    }
                  }
                });
              };
            });
          };

          renderEditor(apps);

          // Add App button
          $('#addApp').onclick = ()=>{ const newApp={ key: randKey(), name:'', url:'', logo:'', hidden:false }; apps.push(newApp); renderEditor(apps); toast('New app row added. Fill fields and click "Save Apps".'); };

          // Save Apps
          $('#saveApps').onclick = async ()=>{
            const edited = apps.map(a=>({ ...a }));
            document.querySelectorAll('#appsEditor [data-k]').forEach(el=>{
              const k=el.getAttribute('data-k'); const key=el.getAttribute('data-key'); const item=edited.find(x=>x.key===key); if(!item) return; if(k==='hidden') item.hidden=el.checked; else item[k]=el.value.trim();
            });
            for(const a of edited){ if(!a.name || !a.url){ toast('Each app needs at least a Name and URL','err'); return; } }
            await api('/api/apps',{ method:'PUT', body: JSON.stringify({ apps: edited }) }); toast('Apps saved'); await loadApps(); renderTiles();
          };
        }

        // SAB settings
        try{
          const sabCfg=await api('/api/sab');
          $('#sabBaseUrl').value=sabCfg.sab.baseUrl||'';
          $('#sabApiKey').value=sabCfg.sab.apiKey||'';
          const saveSabBtn=$('#saveSab');
          if(saveSabBtn){
            saveSabBtn.onclick=async ()=>{
              await api('/api/sab',{ method:'PUT', body: JSON.stringify({ baseUrl: $('#sabBaseUrl').value.trim(), apiKey: $('#sabApiKey').value.trim() }) });
              toast('SAB settings saved');
              $('#testSab')?.click();
            };
          }
          const testSabBtn=$('#testSab');
          if(testSabBtn){
            testSabBtn.onclick=async ()=>{
              try{ const r=await api('/api/sab/test'); if(r.ok) toast('SAB connection successful'); else toast(`SAB test failed (status ${r.status})`,'err'); }
              catch(e){ toast(e.error||'SAB test failed','err'); }
            };
          }
        }catch{}

        // Plex settings
        try{
          const plexCfg = await api('/api/plex');
          if (plexCfg && plexCfg.plex){ const tokInput=$('#plexToken'); const urlInput=$('#plexBaseUrl'); if(tokInput) tokInput.value = plexCfg.plex.token || ''; if(urlInput) urlInput.value = plexCfg.plex.baseUrl || ''; }
          const savePlexBtn=$('#savePlex');
          if (savePlexBtn){
            savePlexBtn.onclick = async ()=>{
              const token=($('#plexToken')?.value||'').trim();
              let baseUrl=($('#plexBaseUrl')?.value||'').trim();
              await api('/api/plex', { method:'PUT', body: JSON.stringify({ baseUrl, token }) });
              toast('Plex settings saved');
              $('#testPlex')?.click();
            };
          }
          const testBtn=$('#testPlex');
          if (testBtn){
            testBtn.onclick = async ()=>{
              try{ const result=await api('/api/plex/test'); if(result.ok) toast('Plex connection successful'); else toast(`Plex test failed (status ${result.status})`,'err'); }
              catch(e){ toast(e.error||'Plex test failed','err'); }
            };
          }
        }catch{}

        await renderUsers();
        await renderInvites();
      }
    }

    function randKey(){ return Math.random().toString(16).slice(2,10); }

    function groupResetCodesByUser(resetCodes){ const m=new Map(); for(const c of resetCodes){ if(!m.has(c.username)) m.set(c.username, []); m.get(c.username).push(c); } for(const [k,arr] of m){ arr.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||'')); } return m; }

    async function renderUsers(){
      const ul = $('#usersList'); if (!ul) return;
      const [usersRes, rcRes] = await Promise.all([ api('/api/users'), api('/api/reset-codes') ]);
      const rcByUser = groupResetCodesByUser(rcRes.resetCodes);
      const adminCount = usersRes.users.filter(u=>u.role==='admin').length;

      ul.innerHTML='';
      for(const u of usersRes.users){
        const row=document.createElement('div'); row.className='bg-white/5 border border-white/10 rounded p-3';
        const codes = rcByUser.get(u.username)||[];
        const initials = ((u.firstName||'')[0]||'') + ((u.lastName||'')[0]||'');
        const avatarHTML = u.profileImage
          ? `<img src="${u.profileImage}" class="h-8 w-8 rounded-full object-cover mr-2" alt="avatar" />`
          : `<span class="mr-2 inline-flex items-center justify-center h-8 w-8 rounded-full text-sm font-semibold" style="background:linear-gradient(135deg, rgba(253,81,58,.9), rgba(44,83,216,.85));">${(initials||u.username||'?').slice(0,2).toUpperCase()}</span>`;

        const displayName = [u.firstName,u.lastName].filter(Boolean).join(' ') || u.username;
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm flex items-center">
              ${avatarHTML}
              <span class="font-semibold truncate max-w-[40vw]">${displayName}</span>
              <span class="text-neutral-300 ml-2">(${u.role})</span>
            </div>
            <div class="flex gap-2">
              <button type="button" data-act="promote" class="px-2 py-1 bg-white/10 rounded">Toggle Admin</button>
              <button type="button" data-act="genreset" class="px-2 py-1 bg-white/10 rounded">Generate Reset Code</button>
              <button type="button" data-act="delete" class="px-2 py-1 bg-red-700/80 rounded">Delete</button>
            </div>
          </div>

          <div class="mt-3">
            <div class="text-xs text-neutral-300 mb-1">Reset Codes</div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-neutral-300">
                  <tr>
                    <th class="text-left py-1">Code</th>
                    <th class="text-left">Expires</th>
                    <th class="text-left">Status</th>
                    <th class="text-right">Actions</th>
                  </tr>
                </thead>
                <tbody>${(codes.map(c=>`
                  <tr class="border-t border-white/10">
                    <td class="py-1 mono pr-2">${c.code}</td>
                    <td class="text-xs">${c.expiresAt||'never'}</td>
                    <td class="text-xs">${c.usedAt?('used '+c.usedAt):'<span class="text-emerald-300">active</span>'}</td>
                    <td class="text-right"><button data-code="${c.code}" class="px-2 py-1 bg-white/10 rounded del-code">Delete</button></td>
                  </tr>`).join('')) || `<tr><td class="py-2 text-neutral-300" colspan="4">None</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>`;

        const promoteBtn = row.querySelector('[data-act="promote"]');
        promoteBtn.disabled = adminCount <= 1 && u.role === 'admin';
        promoteBtn.classList.toggle('opacity-50', promoteBtn.disabled);
        promoteBtn.onclick = async ()=>{ const newRole = u.role==='admin'?'user':'admin'; try{ await api(`/api/users/${u.username}`, { method:'PATCH', body: JSON.stringify({ role:newRole })}); toast('Role updated'); await renderUsers(); }catch(e){ toast(e.error||'Update failed','err'); } };
        row.querySelector('[data-act="genreset"]').onclick = ()=> openResetModal(u.username);
        row.querySelector('[data-act="delete"]').onclick = async ()=>{ if(!confirm(`Delete user ${u.username}? This cannot be undone.`)) return; try{ await api(`/api/users/${encodeURIComponent(u.username)}`, { method:'DELETE' }); toast('User deleted'); await renderUsers(); }catch(e){ toast(e.error||'Delete failed','err'); } };
        row.querySelectorAll('.del-code').forEach(b=> b.onclick = async ()=>{ if(!confirm('Delete this reset code?')) return; await api(`/api/reset-codes/${b.dataset.code}`, { method:'DELETE' }); toast('Reset code deleted'); await renderUsers(); });

        ul.appendChild(row);
      }
    }

    function openResetModal(username){
      const body = `
        <div class="text-sm">Generate a reset code for <span class="font-semibold">${username}</span></div>
        <div>
          <label class="block text-xs mb-1">Expires</label>
          <select id="preset" class="px-3 py-2 rounded bg-white/5 border w-full">
            <option value="1d">1 day</option>
            <option value="7d">7 days</option>
            <option value="1m">1 month</option>
            <option value="6m">6 months</option>
            <option value="never">Never</option>
          </select>
        </div>
        <div id="result" class="hidden mt-2 text-sm">
          <div class="text-neutral-300">Code</div>
          <div id="resultCode" class="mono bg-white/5 border border-white/10 rounded p-2"></div>
          <button id="copyRC" class="mt-2 px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-xs">Copy</button>
        </div>`;
      Modal.open({ title:'Generate Reset Code', bodyHTML: body, confirmText:'Create', onConfirm: async ()=>{ const preset=$('#preset').value; const expiresAt=preset==='never'?null:(()=>{ const d=new Date(); if(preset==='1d') d.setDate(d.getDate()+1); if(preset==='7d') d.setDate(d.getDate()+7); if(preset==='1m') d.setMonth(d.getMonth()+1); if(preset==='6m') d.setMonth(d.getMonth()+6); return d.toISOString(); })(); const r=await api('/api/reset-codes',{ method:'POST', body: JSON.stringify({ username, expiresAt })}); const rcBox=$('#result'); const rc=$('#resultCode'); const copy=$('#copyRC'); if(rcBox&&rc&&copy){ rcBox.classList.remove('hidden'); rc.textContent=r.code; copy.onclick=()=>copyToClipboard(r.code); } toast(`Reset code created for ${username}`); await renderUsers(); } });
    }

    async function renderInvites(){
      const box=$('#invList'); if(!box) return;
      const r=await api('/api/invites');
      const rows=r.invites.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''))
        .map(i=>`<tr class="border-t border-white/10"><td class="py-2 pr-2 mono">${i.code}</td><td>${i.role}</td><td>${i.createdBy||''}</td><td>${i.createdAt||''}</td><td>${i.expiresAt||'never'}</td><td>${i.usedBy||''}</td><td>${i.usedAt||''}</td><td class="text-right"><button data-code="${i.code}" class="px-2 py-1 bg-white/10 rounded copy">Copy</button><button data-code="${i.code}" class="ml-2 px-2 py-1 bg-red-700/80 rounded del">Delete</button></td></tr>`).join('');
      box.innerHTML = `<table class="w-full text-sm"><thead class="text-neutral-300"><tr><th class="text-left py-2">Code</th><th class="text-left">Role</th><th class="text-left">Created by</th><th class="text-left">Created at</th><th class="text-left">Expires</th><th class="text-left">Used by</th><th class="text-left">Used at</th><th class="text-right">Actions</th></tr></thead><tbody>${rows || `<tr><td class="py-2 text-neutral-300" colspan="8">No invites</td></tr>`}</tbody></table>`;
      box.querySelectorAll('.copy').forEach(b=> b.onclick = ()=> copyToClipboard(b.dataset.code));
      box.querySelectorAll('.del').forEach(b=> b.onclick = async ()=>{ if(!confirm(`Delete invite ${b.dataset.code}?`)) return; await api(`/api/invites/${b.dataset.code}`, { method:'DELETE' }); toast('Invite deleted'); await renderInvites(); });
      $('#invCreate').onclick = async ()=>{ const role=$('#invRole').value||'user'; const expiresAt=(()=>{ const p=$('#invPreset').value; if(p==='never') return null; const d=new Date(); if(p==='1d') d.setDate(d.getDate()+1); if(p==='7d') d.setDate(d.getDate()+7); if(p==='1m') d.setMonth(d.getMonth()+1); if(p==='6m') d.setMonth(d.getMonth()+6); return d.toISOString(); })(); const r=await api('/api/invites',{ method:'POST', body: JSON.stringify({ role, expiresAt })}); toast(`Invite created: ${r.code}`); await renderInvites(); };
      $('#eraseUsedInvites').onclick = async ()=>{ if(!confirm('Erase USED invites from history? This cannot be undone.')) return; await api('/api/invites/erase-history',{ method:'POST', body: JSON.stringify({ includeUnused:false }) }); toast('Used invite history cleared'); await renderInvites(); };
      $('#eraseAllInvites').onclick = async ()=>{ if(!confirm('Erase ALL invites? This cannot be undone.')) return; await api('/api/invites/erase-history',{ method:'POST', body: JSON.stringify({ includeUnused:true }) }); toast('All invites cleared'); await renderInvites(); };
    }

    // Tiles (drag & drop + persist)
    function renderTiles(){
      const grid=$('#tiles'); if(!grid) return; grid.innerHTML='';
      for(const a of S.apps){
        const card=document.createElement('a'); card.href=a.url; card.target='_blank'; card.className='tile glass rounded-2xl p-4 flex items-center gap-4 no-underline text-inherit'; card.setAttribute('draggable','true'); card.dataset.key=a.key;
        card.innerHTML = `<img src="${a.logo}" class="h-10 w-10 object-contain" alt="${a.name}"><div><div class="font-semibold">${a.name}</div><div class="text-xs text-neutral-300">${a.url}</div></div>`;
        card.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/app-key', a.key); e.dataTransfer.effectAllowed='move'; card.classList.add('ring-2','ring-white/30'); });
        card.addEventListener('dragend',()=>{ card.classList.remove('ring-2','ring-white/30'); });
        card.addEventListener('dragover',(e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
        card.addEventListener('drop', async (e)=>{ e.preventDefault(); const draggedKey=e.dataTransfer.getData('text/app-key'); const targetKey=card.dataset.key; if(!draggedKey||draggedKey===targetKey) return; const keys=S.apps.map(x=>x.key); const from=keys.indexOf(draggedKey); const to=keys.indexOf(targetKey); if(from<0||to<0) return; const moved=S.apps.splice(from,1)[0]; S.apps.splice(to,0,moved); renderTiles(); await saveAppOrder(S.apps.map(x=>x.key)); });
        grid.appendChild(card);
      }
      if(!localStorage.getItem('zm_dnd_hint')){ const hint=document.createElement('div'); hint.className='text-xs text-neutral-300 mt-2'; hint.textContent='Tip: Drag tiles to rearrange. Your layout is saved to your account.'; grid.parentElement.appendChild(hint); localStorage.setItem('zm_dnd_hint','1'); }
    }

    // SAB queue
    async function fetchSab(page){
      try{ const r=await api(`/api/sab/queue?page=${page}`); S.sabPage=r.page; S.sabPages=r.pages||1; const tbody=$('#sabRows'); const rows=(r.slots||[]).map(s=>{ const pct=Math.max(0,Math.min(100,Number(s.percentage||0))); return `<tr class="border-t border-white/10"><td class="py-2 pr-2">${s.filename}</td><td>${s.status}</td><td class="w-56"><div class="relative bar h-5"><span style="width:${pct}%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">${pct}%</div></div></td><td class="text-right">${s.timeleft||''}</td></tr>`; }).join(''); tbody.innerHTML = rows || `<tr class="border-t border-white/10"><td class="py-2 pr-2 text-neutral-300">–</td><td class="text-neutral-300">–</td><td class="w-56"><div class="relative bar h-5"><span style="width:0%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">0%</div></div></td><td class="text-right text-neutral-300">–</td></tr>`; const sp=r.speedText||(r.speed?((r.speed>=1024?(r.speed/1024).toFixed(2)+' MB/s':r.speed.toFixed(0)+' KB/s')):'0 KB/s'); $('#sabStatus').textContent=`Speed: ${sp}${r.paused?' (paused)':''}`; const pageText=$('#sabPage'); const prevBtn=$('#sabPrev'); const nextBtn=$('#sabNext'); if(S.sabPages>1){ pageText.textContent=`Page ${S.sabPage} / ${S.sabPages}`; prevBtn.disabled=S.sabPage<=1; nextBtn.disabled=S.sabPage>=S.sabPages; prevBtn.classList.toggle('opacity-50', prevBtn.disabled); nextBtn.classList.toggle('opacity-50', nextBtn.disabled); pageText.parentElement.classList.remove('hidden'); } else { pageText.parentElement.classList.add('hidden'); } }
      catch{ $('#sabRows').innerHTML = `<tr class="border-t border-white/10"><td class="py-2 pr-2 text-neutral-300">–</td><td class="text-neutral-300">–</td><td class="w-56"><div class="relative bar h-5"><span style="width:0%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">0%</div></div></td><td class="text-right text-neutral-300">–</td></tr>`; $('#sabStatus').textContent=''; const pageWrap=$('#sabPage')?.parentElement; if(pageWrap) pageWrap.classList.add('hidden'); }
    }
    function startSabPolling(){ clearInterval(S.sabTimer); if(typeof S.sabPage!=='number'||S.sabPage<1) S.sabPage=1; fetchSab(S.sabPage); S.sabTimer=setInterval(()=>fetchSab(S.sabPage), 3000); $('#sabPrev').onclick=()=>{ if(S.sabPage>1){ S.sabPage--; fetchSab(S.sabPage);} }; $('#sabNext').onclick=()=>{ if(S.sabPages && S.sabPage<S.sabPages){ S.sabPage++; fetchSab(S.sabPage);} }; }

    // NOW PLAYING (Plex)
    function shouldShowNowPlaying(){ if(!S.me||S.me.role!=='admin') return false; const pref=S.me.preferences||{}; return (pref.showNowPlaying!==false); }
    async function fetchNowPlaying(){ try{ const r=await api('/api/now-playing'); const sessions=Array.isArray(r)?r:(r.sessions||[]); const wrap=$('#nowPlayingWrap'); const box=$('#nowPlaying'); const meta=$('#npMeta'); if(!shouldShowNowPlaying()){ wrap.classList.add('hidden'); return; } wrap.classList.remove('hidden'); window.__npSampledAt=Date.now(); meta.textContent = sessions.length ? `${sessions.length} active session${sessions.length>1?'s':''}` : ''; if(!sessions.length){ box.innerHTML = `<div class="text-sm text-neutral-300">No one is watching right now.</div>`; return; } box.innerHTML = sessions.map(s=>{ const viewOffsetMs=(typeof s.viewOffsetMs==='number')?s.viewOffsetMs:(typeof s.viewOffset==='number'?s.viewOffset:null); const durationMs=(typeof s.durationMs==='number')?s.durationMs:(typeof s.duration==='number'?s.duration:null); const posSec=viewOffsetMs!=null?viewOffsetMs/1000:null; const durSec=durationMs!=null?durationMs/1000:null; const pctFromTime=(posSec!=null && durSec>0)?Math.max(0,Math.min(100,(posSec/durSec)*100)):null; const pct=pctFromTime!=null?pctFromTime:Math.max(0,Math.min(100,Number(s.progress||0))); const u=s.user||'Unknown'; const t=s.title||''; const q=s.quality?` • ${s.quality}`:''; const state=s.state==='paused'?' (paused)':''; const timeText=(posSec!=null && durSec>0)?`${fmtTime(posSec)} / ${fmtTime(durSec)}`:`${pct.toFixed(0)}%`; return `<div class="flex items-center justify-between py-2 border-t border-white/10" data-npid="${(s.id||t+u).toString().replace(/"/g,'')}" data-duration="${durationMs||''}" data-offset="${viewOffsetMs||''}" data-state="${s.state||''}"><div class="min-w-0 pr-4"><div class="font-semibold truncate">${u}${state}</div><div class="text-xs text-neutral-300 truncate">${t}${q}${s.device?` • ${s.device}`:''}</div></div><div class="w-56"><div class="relative bar h-4"><span style="width:${pct}%"></span><div class="absolute inset-0 flex items-center justify-center text-[10px]" data-role="np-time">${timeText}</div></div></div></div>`; }).join(''); startNowPlayingClock(); }catch(e){ const wrap=$('#nowPlayingWrap'); if(shouldShowNowPlaying()){ wrap.classList.remove('hidden'); $('#nowPlaying').innerHTML = `<div class="text-sm text-red-300">Now Playing unavailable.</div>`; $('#npMeta').textContent=''; } else { wrap.classList.add('hidden'); } } }
    function startNowPlayingClock(){ try{ if(S.npClock){ clearInterval(S.npClock); } S.npClock=setInterval(()=>{ const sampledAt=window.__npSampledAt||Date.now(); const delta=Date.now()-sampledAt; document.querySelectorAll('#nowPlaying [data-duration]').forEach(row=>{ const duration=Number(row.getAttribute('data-duration')||0); let offset=Number(row.getAttribute('data-offset')||0); const state=(row.getAttribute('data-state')||'').toLowerCase(); if(!duration||duration<=0) return; if(state!=='paused') offset=offset+delta; const posSec=Math.max(0,Math.min(duration,offset))/1000; const durSec=duration/1000; const pct=Math.max(0,Math.min(100,(posSec/durSec)*100)); const bar=row.querySelector('.bar span'); if(bar) bar.style.width=pct+'%'; const lab=row.querySelector('[data-role="np-time"]'); if(lab) lab.textContent=`${fmtTime(posSec)} / ${fmtTime(durSec)}`; }); }, 1000); }catch{} }
    function startNowPlayingPolling(){ clearInterval(S.npTimer); if(!shouldShowNowPlaying()){ $('#nowPlayingWrap').classList.add('hidden'); return; } fetchNowPlaying(); S.npTimer=setInterval(fetchNowPlaying, 5000); }

    function hasMfaEnabled(){ return !!(S.me && S.me.totpSecret); }
    async function setupMfaUI(){
      const box=$('#mfaBox'); if(!box) return;
      const enabled=hasMfaEnabled();
      $('#mfaStatus').textContent = enabled ? 'Enabled' : 'Disabled';
      $('#mfaStart').classList.toggle('hidden', enabled);
      $('#mfaDisable').classList.toggle('hidden', !enabled);
      $('#mfaSetup').classList.add('hidden');
      $('#mfaStart').onclick = async ()=>{
        try{
          const r=await api('/api/me',{ method:'PUT', body: JSON.stringify({ mfaAction:'start' }) });
          if(r.otpauth){
            const sec = r.secret || (()=>{ try{ const u=new URL(r.otpauth); return new URLSearchParams(u.search).get('secret')||''; }catch{} return ''; })();
            $('#mfaSetup').classList.remove('hidden');
            renderQRTo('#mfaQr', r.otpauth);
            $('#mfaOtpauth').textContent=r.otpauth;
            $('#mfaSecret').textContent=sec;
            $('#mfaCopyLink').onclick=()=>copyToClipboard(r.otpauth);
            $('#mfaCopySecret').onclick=()=>copyToClipboard(sec);
            S.me = r.user || S.me;
          }
        }catch(e){ toast(e.error||'Failed to start setup','err'); }
      };
      $('#mfaDisable').onclick = async ()=>{
        if(!confirm('Disable authenticator app for this account?')) return;
        try{
          const r=await api('/api/me',{ method:'PUT', body: JSON.stringify({ mfaAction:'disable' }) });
          S.me=r.user; toast('MFA disabled'); setupMfaUI();
        }catch(e){ toast(e.error||'Failed to disable','err'); }
      };
      $('#mfaVerify').onclick = async ()=>{
        const code=$('#mfaCode').value.trim();
        if(!/^[0-9]{6}$/.test(code)){
          toast('Enter the 6‑digit code from your app','err');
          return;
        }
        try{
          const r=await api('/api/me',{ method:'PUT', body: JSON.stringify({ mfaAction:'verify', code }) });
          S.me=r.user; toast('MFA enabled and saved'); setupMfaUI();
        }catch(e){ toast(e.error||'Verification failed','err'); }
      };
    }

    // Settings (profile + picture + prefs)
    function populateMeForm(){ const f=document.getElementById('meForm'); if(!f||!S.me) return; f.username.value=''; f.password.value=''; f.firstName.value = S.me.firstName || ''; f.lastName.value = S.me.lastName || ''; }
    document.getElementById('meForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const fd=new FormData(e.target);
      const body = { username: fd.get('username')||undefined, password: fd.get('password')||undefined, firstName: (fd.get('firstName')||'').trim(), lastName: (fd.get('lastName')||'').trim() };
      const cb=$('#prefShowNP'); if(cb && S.me && S.me.role==='admin'){ body.preferences = Object.assign({}, S.me.preferences||{}, { showNowPlaying: !!cb.checked }); }
      if($('#pfp') && $('#pfp').files[0]){ const file=$('#pfp').files[0]; body.profileImage = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
      try{ const r=await api('/api/me',{ method:'PUT', body: JSON.stringify(body) }); S.me=r.user; toast('Saved.'); const displayName=[S.me.firstName,S.me.lastName].filter(Boolean).join(' ')||S.me.username; $('#userName').textContent = displayName; const ua=$('#userAvatar'), ui=$('#userInitial'); if(S.me.profileImage){ ua.src=S.me.profileImage; ua.classList.remove('hidden'); ui.classList.add('hidden'); } else { ui.textContent = initialsFor(S.me); ui.classList.remove('hidden'); ua.classList.add('hidden'); } }
      catch(err){ toast(err.error||'Save failed','err'); }
    });
    $('#btn-admin-close').onclick = ()=> show('#view-apps');
    $('#btn-settings-close').onclick = ()=> show('#view-apps');

    // SAB controls
    function startSab(){ startSabPolling(); }

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
