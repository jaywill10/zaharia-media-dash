(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(t){if(t.ep)return;t.ep=!0;const o=i(t);fetch(t.href,o)}})();function kt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var j={},ie,$e;function Pt(){return $e||($e=1,ie=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),ie}var ae={},O={},qe;function _(){if(qe)return O;qe=1;let n;const r=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return O.getSymbolSize=function(e){if(!e)throw new Error('"version" cannot be null or undefined');if(e<1||e>40)throw new Error('"version" should be in range from 1 to 40');return e*4+17},O.getSymbolTotalCodewords=function(e){return r[e]},O.getBCHDigit=function(i){let e=0;for(;i!==0;)e++,i>>>=1;return e},O.setToSJISFunction=function(e){if(typeof e!="function")throw new Error('"toSJISFunc" is not a valid function.');n=e},O.isKanjiModeEnabled=function(){return typeof n<"u"},O.toSJIS=function(e){return n(e)},O}var se={},Fe;function xe(){return Fe||(Fe=1,(function(n){n.L={bit:1},n.M={bit:0},n.Q={bit:3},n.H={bit:2};function r(i){if(typeof i!="string")throw new Error("Param is not a string");switch(i.toLowerCase()){case"l":case"low":return n.L;case"m":case"medium":return n.M;case"q":case"quartile":return n.Q;case"h":case"high":return n.H;default:throw new Error("Unknown EC Level: "+i)}}n.isValid=function(e){return e&&typeof e.bit<"u"&&e.bit>=0&&e.bit<4},n.from=function(e,t){if(n.isValid(e))return e;try{return r(e)}catch{return t}}})(se)),se}var ce,Oe;function Tt(){if(Oe)return ce;Oe=1;function n(){this.buffer=[],this.length=0}return n.prototype={get:function(r){const i=Math.floor(r/8);return(this.buffer[i]>>>7-r%8&1)===1},put:function(r,i){for(let e=0;e<i;e++)this.putBit((r>>>i-e-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(r){const i=Math.floor(this.length/8);this.buffer.length<=i&&this.buffer.push(0),r&&(this.buffer[i]|=128>>>this.length%8),this.length++}},ce=n,ce}var le,_e;function At(){if(_e)return le;_e=1;function n(r){if(!r||r<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=r,this.data=new Uint8Array(r*r),this.reservedBit=new Uint8Array(r*r)}return n.prototype.set=function(r,i,e,t){const o=r*this.size+i;this.data[o]=e,t&&(this.reservedBit[o]=!0)},n.prototype.get=function(r,i){return this.data[r*this.size+i]},n.prototype.xor=function(r,i,e){this.data[r*this.size+i]^=e},n.prototype.isReserved=function(r,i){return this.reservedBit[r*this.size+i]},le=n,le}var de={},He;function Nt(){return He||(He=1,(function(n){const r=_().getSymbolSize;n.getRowColCoords=function(e){if(e===1)return[];const t=Math.floor(e/7)+2,o=r(e),a=o===145?26:Math.ceil((o-13)/(2*t-2))*2,c=[o-7];for(let s=1;s<t-1;s++)c[s]=c[s-1]-a;return c.push(6),c.reverse()},n.getPositions=function(e){const t=[],o=n.getRowColCoords(e),a=o.length;for(let c=0;c<a;c++)for(let s=0;s<a;s++)c===0&&s===0||c===0&&s===a-1||c===a-1&&s===0||t.push([o[c],o[s]]);return t}})(de)),de}var ue={},Je;function Lt(){if(Je)return ue;Je=1;const n=_().getSymbolSize,r=7;return ue.getPositions=function(e){const t=n(e);return[[0,0],[t-r,0],[0,t-r]]},ue}var fe={},je;function Bt(){return je||(je=1,(function(n){n.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const r={N1:3,N2:3,N3:40,N4:10};n.isValid=function(t){return t!=null&&t!==""&&!isNaN(t)&&t>=0&&t<=7},n.from=function(t){return n.isValid(t)?parseInt(t,10):void 0},n.getPenaltyN1=function(t){const o=t.size;let a=0,c=0,s=0,d=null,f=null;for(let m=0;m<o;m++){c=s=0,d=f=null;for(let h=0;h<o;h++){let g=t.get(m,h);g===d?c++:(c>=5&&(a+=r.N1+(c-5)),d=g,c=1),g=t.get(h,m),g===f?s++:(s>=5&&(a+=r.N1+(s-5)),f=g,s=1)}c>=5&&(a+=r.N1+(c-5)),s>=5&&(a+=r.N1+(s-5))}return a},n.getPenaltyN2=function(t){const o=t.size;let a=0;for(let c=0;c<o-1;c++)for(let s=0;s<o-1;s++){const d=t.get(c,s)+t.get(c,s+1)+t.get(c+1,s)+t.get(c+1,s+1);(d===4||d===0)&&a++}return a*r.N2},n.getPenaltyN3=function(t){const o=t.size;let a=0,c=0,s=0;for(let d=0;d<o;d++){c=s=0;for(let f=0;f<o;f++)c=c<<1&2047|t.get(d,f),f>=10&&(c===1488||c===93)&&a++,s=s<<1&2047|t.get(f,d),f>=10&&(s===1488||s===93)&&a++}return a*r.N3},n.getPenaltyN4=function(t){let o=0;const a=t.data.length;for(let s=0;s<a;s++)o+=t.data[s];return Math.abs(Math.ceil(o*100/a/5)-10)*r.N4};function i(e,t,o){switch(e){case n.Patterns.PATTERN000:return(t+o)%2===0;case n.Patterns.PATTERN001:return t%2===0;case n.Patterns.PATTERN010:return o%3===0;case n.Patterns.PATTERN011:return(t+o)%3===0;case n.Patterns.PATTERN100:return(Math.floor(t/2)+Math.floor(o/3))%2===0;case n.Patterns.PATTERN101:return t*o%2+t*o%3===0;case n.Patterns.PATTERN110:return(t*o%2+t*o%3)%2===0;case n.Patterns.PATTERN111:return(t*o%3+(t+o)%2)%2===0;default:throw new Error("bad maskPattern:"+e)}}n.applyMask=function(t,o){const a=o.size;for(let c=0;c<a;c++)for(let s=0;s<a;s++)o.isReserved(s,c)||o.xor(s,c,i(t,s,c))},n.getBestMask=function(t,o){const a=Object.keys(n.Patterns).length;let c=0,s=1/0;for(let d=0;d<a;d++){o(d),n.applyMask(d,t);const f=n.getPenaltyN1(t)+n.getPenaltyN2(t)+n.getPenaltyN3(t)+n.getPenaltyN4(t);n.applyMask(d,t),f<s&&(s=f,c=d)}return c}})(fe)),fe}var W={},ze;function mt(){if(ze)return W;ze=1;const n=xe(),r=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],i=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return W.getBlocksCount=function(t,o){switch(o){case n.L:return r[(t-1)*4+0];case n.M:return r[(t-1)*4+1];case n.Q:return r[(t-1)*4+2];case n.H:return r[(t-1)*4+3];default:return}},W.getTotalCodewordsCount=function(t,o){switch(o){case n.L:return i[(t-1)*4+0];case n.M:return i[(t-1)*4+1];case n.Q:return i[(t-1)*4+2];case n.H:return i[(t-1)*4+3];default:return}},W}var me={},K={},Ke;function Mt(){if(Ke)return K;Ke=1;const n=new Uint8Array(512),r=new Uint8Array(256);return(function(){let e=1;for(let t=0;t<255;t++)n[t]=e,r[e]=t,e<<=1,e&256&&(e^=285);for(let t=255;t<512;t++)n[t]=n[t-255]})(),K.log=function(e){if(e<1)throw new Error("log("+e+")");return r[e]},K.exp=function(e){return n[e]},K.mul=function(e,t){return e===0||t===0?0:n[r[e]+r[t]]},K}var Ve;function xt(){return Ve||(Ve=1,(function(n){const r=Mt();n.mul=function(e,t){const o=new Uint8Array(e.length+t.length-1);for(let a=0;a<e.length;a++)for(let c=0;c<t.length;c++)o[a+c]^=r.mul(e[a],t[c]);return o},n.mod=function(e,t){let o=new Uint8Array(e);for(;o.length-t.length>=0;){const a=o[0];for(let s=0;s<t.length;s++)o[s]^=r.mul(t[s],a);let c=0;for(;c<o.length&&o[c]===0;)c++;o=o.slice(c)}return o},n.generateECPolynomial=function(e){let t=new Uint8Array([1]);for(let o=0;o<e;o++)t=n.mul(t,new Uint8Array([1,r.exp(o)]));return t}})(me)),me}var ge,Ye;function It(){if(Ye)return ge;Ye=1;const n=xt();function r(i){this.genPoly=void 0,this.degree=i,this.degree&&this.initialize(this.degree)}return r.prototype.initialize=function(e){this.degree=e,this.genPoly=n.generateECPolynomial(this.degree)},r.prototype.encode=function(e){if(!this.genPoly)throw new Error("Encoder not initialized");const t=new Uint8Array(e.length+this.degree);t.set(e);const o=n.mod(t,this.genPoly),a=this.degree-o.length;if(a>0){const c=new Uint8Array(this.degree);return c.set(o,a),c}return o},ge=r,ge}var he={},pe={},ye={},Qe;function gt(){return Qe||(Qe=1,ye.isValid=function(r){return!isNaN(r)&&r>=1&&r<=40}),ye}var U={},Ge;function ht(){if(Ge)return U;Ge=1;const n="[0-9]+",r="[A-Z $%*+\\-./:]+";let i="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";i=i.replace(/u/g,"\\u");const e="(?:(?![A-Z0-9 $%*+\\-./:]|"+i+`)(?:.|[\r
]))+`;U.KANJI=new RegExp(i,"g"),U.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),U.BYTE=new RegExp(e,"g"),U.NUMERIC=new RegExp(n,"g"),U.ALPHANUMERIC=new RegExp(r,"g");const t=new RegExp("^"+i+"$"),o=new RegExp("^"+n+"$"),a=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return U.testKanji=function(s){return t.test(s)},U.testNumeric=function(s){return o.test(s)},U.testAlphanumeric=function(s){return a.test(s)},U}var We;function H(){return We||(We=1,(function(n){const r=gt(),i=ht();n.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},n.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},n.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},n.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},n.MIXED={bit:-1},n.getCharCountIndicator=function(o,a){if(!o.ccBits)throw new Error("Invalid mode: "+o);if(!r.isValid(a))throw new Error("Invalid version: "+a);return a>=1&&a<10?o.ccBits[0]:a<27?o.ccBits[1]:o.ccBits[2]},n.getBestModeForData=function(o){return i.testNumeric(o)?n.NUMERIC:i.testAlphanumeric(o)?n.ALPHANUMERIC:i.testKanji(o)?n.KANJI:n.BYTE},n.toString=function(o){if(o&&o.id)return o.id;throw new Error("Invalid mode")},n.isValid=function(o){return o&&o.bit&&o.ccBits};function e(t){if(typeof t!="string")throw new Error("Param is not a string");switch(t.toLowerCase()){case"numeric":return n.NUMERIC;case"alphanumeric":return n.ALPHANUMERIC;case"kanji":return n.KANJI;case"byte":return n.BYTE;default:throw new Error("Unknown mode: "+t)}}n.from=function(o,a){if(n.isValid(o))return o;try{return e(o)}catch{return a}}})(pe)),pe}var Ze;function Rt(){return Ze||(Ze=1,(function(n){const r=_(),i=mt(),e=xe(),t=H(),o=gt(),a=7973,c=r.getBCHDigit(a);function s(h,g,N){for(let B=1;B<=40;B++)if(g<=n.getCapacity(B,N,h))return B}function d(h,g){return t.getCharCountIndicator(h,g)+4}function f(h,g){let N=0;return h.forEach(function(B){const I=d(B.mode,g);N+=I+B.getBitsLength()}),N}function m(h,g){for(let N=1;N<=40;N++)if(f(h,N)<=n.getCapacity(N,g,t.MIXED))return N}n.from=function(g,N){return o.isValid(g)?parseInt(g,10):N},n.getCapacity=function(g,N,B){if(!o.isValid(g))throw new Error("Invalid QR Code version");typeof B>"u"&&(B=t.BYTE);const I=r.getSymbolTotalCodewords(g),T=i.getTotalCodewordsCount(g,N),x=(I-T)*8;if(B===t.MIXED)return x;const A=x-d(B,g);switch(B){case t.NUMERIC:return Math.floor(A/10*3);case t.ALPHANUMERIC:return Math.floor(A/11*2);case t.KANJI:return Math.floor(A/13);case t.BYTE:default:return Math.floor(A/8)}},n.getBestVersionForData=function(g,N){let B;const I=e.from(N,e.M);if(Array.isArray(g)){if(g.length>1)return m(g,I);if(g.length===0)return 1;B=g[0]}else B=g;return s(B.mode,B.getLength(),I)},n.getEncodedBits=function(g){if(!o.isValid(g)||g<7)throw new Error("Invalid QR Code version");let N=g<<12;for(;r.getBCHDigit(N)-c>=0;)N^=a<<r.getBCHDigit(N)-c;return g<<12|N}})(he)),he}var we={},Xe;function Dt(){if(Xe)return we;Xe=1;const n=_(),r=1335,i=21522,e=n.getBCHDigit(r);return we.getEncodedBits=function(o,a){const c=o.bit<<3|a;let s=c<<10;for(;n.getBCHDigit(s)-e>=0;)s^=r<<n.getBCHDigit(s)-e;return(c<<10|s)^i},we}var be={},ve,et;function Ut(){if(et)return ve;et=1;const n=H();function r(i){this.mode=n.NUMERIC,this.data=i.toString()}return r.getBitsLength=function(e){return 10*Math.floor(e/3)+(e%3?e%3*3+1:0)},r.prototype.getLength=function(){return this.data.length},r.prototype.getBitsLength=function(){return r.getBitsLength(this.data.length)},r.prototype.write=function(e){let t,o,a;for(t=0;t+3<=this.data.length;t+=3)o=this.data.substr(t,3),a=parseInt(o,10),e.put(a,10);const c=this.data.length-t;c>0&&(o=this.data.substr(t),a=parseInt(o,10),e.put(a,c*3+1))},ve=r,ve}var Ce,tt;function $t(){if(tt)return Ce;tt=1;const n=H(),r=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function i(e){this.mode=n.ALPHANUMERIC,this.data=e}return i.getBitsLength=function(t){return 11*Math.floor(t/2)+6*(t%2)},i.prototype.getLength=function(){return this.data.length},i.prototype.getBitsLength=function(){return i.getBitsLength(this.data.length)},i.prototype.write=function(t){let o;for(o=0;o+2<=this.data.length;o+=2){let a=r.indexOf(this.data[o])*45;a+=r.indexOf(this.data[o+1]),t.put(a,11)}this.data.length%2&&t.put(r.indexOf(this.data[o]),6)},Ce=i,Ce}var Ee,nt;function qt(){if(nt)return Ee;nt=1;const n=H();function r(i){this.mode=n.BYTE,typeof i=="string"?this.data=new TextEncoder().encode(i):this.data=new Uint8Array(i)}return r.getBitsLength=function(e){return e*8},r.prototype.getLength=function(){return this.data.length},r.prototype.getBitsLength=function(){return r.getBitsLength(this.data.length)},r.prototype.write=function(i){for(let e=0,t=this.data.length;e<t;e++)i.put(this.data[e],8)},Ee=r,Ee}var Se,rt;function Ft(){if(rt)return Se;rt=1;const n=H(),r=_();function i(e){this.mode=n.KANJI,this.data=e}return i.getBitsLength=function(t){return t*13},i.prototype.getLength=function(){return this.data.length},i.prototype.getBitsLength=function(){return i.getBitsLength(this.data.length)},i.prototype.write=function(e){let t;for(t=0;t<this.data.length;t++){let o=r.toSJIS(this.data[t]);if(o>=33088&&o<=40956)o-=33088;else if(o>=57408&&o<=60351)o-=49472;else throw new Error("Invalid SJIS character: "+this.data[t]+`
Make sure your charset is UTF-8`);o=(o>>>8&255)*192+(o&255),e.put(o,13)}},Se=i,Se}var ke={exports:{}},ot;function Ot(){return ot||(ot=1,(function(n){var r={single_source_shortest_paths:function(i,e,t){var o={},a={};a[e]=0;var c=r.PriorityQueue.make();c.push(e,0);for(var s,d,f,m,h,g,N,B,I;!c.empty();){s=c.pop(),d=s.value,m=s.cost,h=i[d]||{};for(f in h)h.hasOwnProperty(f)&&(g=h[f],N=m+g,B=a[f],I=typeof a[f]>"u",(I||B>N)&&(a[f]=N,c.push(f,N),o[f]=d))}if(typeof t<"u"&&typeof a[t]>"u"){var T=["Could not find a path from ",e," to ",t,"."].join("");throw new Error(T)}return o},extract_shortest_path_from_predecessor_list:function(i,e){for(var t=[],o=e;o;)t.push(o),i[o],o=i[o];return t.reverse(),t},find_path:function(i,e,t){var o=r.single_source_shortest_paths(i,e,t);return r.extract_shortest_path_from_predecessor_list(o,t)},PriorityQueue:{make:function(i){var e=r.PriorityQueue,t={},o;i=i||{};for(o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);return t.queue=[],t.sorter=i.sorter||e.default_sorter,t},default_sorter:function(i,e){return i.cost-e.cost},push:function(i,e){var t={value:i,cost:e};this.queue.push(t),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};n.exports=r})(ke)),ke.exports}var it;function _t(){return it||(it=1,(function(n){const r=H(),i=Ut(),e=$t(),t=qt(),o=Ft(),a=ht(),c=_(),s=Ot();function d(T){return unescape(encodeURIComponent(T)).length}function f(T,x,A){const k=[];let R;for(;(R=T.exec(A))!==null;)k.push({data:R[0],index:R.index,mode:x,length:R[0].length});return k}function m(T){const x=f(a.NUMERIC,r.NUMERIC,T),A=f(a.ALPHANUMERIC,r.ALPHANUMERIC,T);let k,R;return c.isKanjiModeEnabled()?(k=f(a.BYTE,r.BYTE,T),R=f(a.KANJI,r.KANJI,T)):(k=f(a.BYTE_KANJI,r.BYTE,T),R=[]),x.concat(A,k,R).sort(function(C,v){return C.index-v.index}).map(function(C){return{data:C.data,mode:C.mode,length:C.length}})}function h(T,x){switch(x){case r.NUMERIC:return i.getBitsLength(T);case r.ALPHANUMERIC:return e.getBitsLength(T);case r.KANJI:return o.getBitsLength(T);case r.BYTE:return t.getBitsLength(T)}}function g(T){return T.reduce(function(x,A){const k=x.length-1>=0?x[x.length-1]:null;return k&&k.mode===A.mode?(x[x.length-1].data+=A.data,x):(x.push(A),x)},[])}function N(T){const x=[];for(let A=0;A<T.length;A++){const k=T[A];switch(k.mode){case r.NUMERIC:x.push([k,{data:k.data,mode:r.ALPHANUMERIC,length:k.length},{data:k.data,mode:r.BYTE,length:k.length}]);break;case r.ALPHANUMERIC:x.push([k,{data:k.data,mode:r.BYTE,length:k.length}]);break;case r.KANJI:x.push([k,{data:k.data,mode:r.BYTE,length:d(k.data)}]);break;case r.BYTE:x.push([{data:k.data,mode:r.BYTE,length:d(k.data)}])}}return x}function B(T,x){const A={},k={start:{}};let R=["start"];for(let y=0;y<T.length;y++){const C=T[y],v=[];for(let p=0;p<C.length;p++){const P=C[p],w=""+y+p;v.push(w),A[w]={node:P,lastCount:0},k[w]={};for(let E=0;E<R.length;E++){const b=R[E];A[b]&&A[b].node.mode===P.mode?(k[b][w]=h(A[b].lastCount+P.length,P.mode)-h(A[b].lastCount,P.mode),A[b].lastCount+=P.length):(A[b]&&(A[b].lastCount=P.length),k[b][w]=h(P.length,P.mode)+4+r.getCharCountIndicator(P.mode,x))}}R=v}for(let y=0;y<R.length;y++)k[R[y]].end=0;return{map:k,table:A}}function I(T,x){let A;const k=r.getBestModeForData(T);if(A=r.from(x,k),A!==r.BYTE&&A.bit<k.bit)throw new Error('"'+T+'" cannot be encoded with mode '+r.toString(A)+`.
 Suggested mode is: `+r.toString(k));switch(A===r.KANJI&&!c.isKanjiModeEnabled()&&(A=r.BYTE),A){case r.NUMERIC:return new i(T);case r.ALPHANUMERIC:return new e(T);case r.KANJI:return new o(T);case r.BYTE:return new t(T)}}n.fromArray=function(x){return x.reduce(function(A,k){return typeof k=="string"?A.push(I(k,null)):k.data&&A.push(I(k.data,k.mode)),A},[])},n.fromString=function(x,A){const k=m(x,c.isKanjiModeEnabled()),R=N(k),y=B(R,A),C=s.find_path(y.map,"start","end"),v=[];for(let p=1;p<C.length-1;p++)v.push(y.table[C[p]].node);return n.fromArray(g(v))},n.rawSplit=function(x){return n.fromArray(m(x,c.isKanjiModeEnabled()))}})(be)),be}var at;function Ht(){if(at)return ae;at=1;const n=_(),r=xe(),i=Tt(),e=At(),t=Nt(),o=Lt(),a=Bt(),c=mt(),s=It(),d=Rt(),f=Dt(),m=H(),h=_t();function g(y,C){const v=y.size,p=o.getPositions(C);for(let P=0;P<p.length;P++){const w=p[P][0],E=p[P][1];for(let b=-1;b<=7;b++)if(!(w+b<=-1||v<=w+b))for(let L=-1;L<=7;L++)E+L<=-1||v<=E+L||(b>=0&&b<=6&&(L===0||L===6)||L>=0&&L<=6&&(b===0||b===6)||b>=2&&b<=4&&L>=2&&L<=4?y.set(w+b,E+L,!0,!0):y.set(w+b,E+L,!1,!0))}}function N(y){const C=y.size;for(let v=8;v<C-8;v++){const p=v%2===0;y.set(v,6,p,!0),y.set(6,v,p,!0)}}function B(y,C){const v=t.getPositions(C);for(let p=0;p<v.length;p++){const P=v[p][0],w=v[p][1];for(let E=-2;E<=2;E++)for(let b=-2;b<=2;b++)E===-2||E===2||b===-2||b===2||E===0&&b===0?y.set(P+E,w+b,!0,!0):y.set(P+E,w+b,!1,!0)}}function I(y,C){const v=y.size,p=d.getEncodedBits(C);let P,w,E;for(let b=0;b<18;b++)P=Math.floor(b/3),w=b%3+v-8-3,E=(p>>b&1)===1,y.set(P,w,E,!0),y.set(w,P,E,!0)}function T(y,C,v){const p=y.size,P=f.getEncodedBits(C,v);let w,E;for(w=0;w<15;w++)E=(P>>w&1)===1,w<6?y.set(w,8,E,!0):w<8?y.set(w+1,8,E,!0):y.set(p-15+w,8,E,!0),w<8?y.set(8,p-w-1,E,!0):w<9?y.set(8,15-w-1+1,E,!0):y.set(8,15-w-1,E,!0);y.set(p-8,8,1,!0)}function x(y,C){const v=y.size;let p=-1,P=v-1,w=7,E=0;for(let b=v-1;b>0;b-=2)for(b===6&&b--;;){for(let L=0;L<2;L++)if(!y.isReserved(P,b-L)){let F=!1;E<C.length&&(F=(C[E]>>>w&1)===1),y.set(P,b-L,F),w--,w===-1&&(E++,w=7)}if(P+=p,P<0||v<=P){P-=p,p=-p;break}}}function A(y,C,v){const p=new i;v.forEach(function(L){p.put(L.mode.bit,4),p.put(L.getLength(),m.getCharCountIndicator(L.mode,y)),L.write(p)});const P=n.getSymbolTotalCodewords(y),w=c.getTotalCodewordsCount(y,C),E=(P-w)*8;for(p.getLengthInBits()+4<=E&&p.put(0,4);p.getLengthInBits()%8!==0;)p.putBit(0);const b=(E-p.getLengthInBits())/8;for(let L=0;L<b;L++)p.put(L%2?17:236,8);return k(p,y,C)}function k(y,C,v){const p=n.getSymbolTotalCodewords(C),P=c.getTotalCodewordsCount(C,v),w=p-P,E=c.getBlocksCount(C,v),b=p%E,L=E-b,F=Math.floor(p/E),z=Math.floor(w/E),Ct=z+1,Re=F-z,Et=new s(Re);let te=0;const G=new Array(E),De=new Array(E);let ne=0;const St=new Uint8Array(y.buffer);for(let J=0;J<E;J++){const oe=J<L?z:Ct;G[J]=St.slice(te,te+oe),De[J]=Et.encode(G[J]),te+=oe,ne=Math.max(ne,oe)}const re=new Uint8Array(p);let Ue=0,$,q;for($=0;$<ne;$++)for(q=0;q<E;q++)$<G[q].length&&(re[Ue++]=G[q][$]);for($=0;$<Re;$++)for(q=0;q<E;q++)re[Ue++]=De[q][$];return re}function R(y,C,v,p){let P;if(Array.isArray(y))P=h.fromArray(y);else if(typeof y=="string"){let F=C;if(!F){const z=h.rawSplit(y);F=d.getBestVersionForData(z,v)}P=h.fromString(y,F||40)}else throw new Error("Invalid data");const w=d.getBestVersionForData(P,v);if(!w)throw new Error("The amount of data is too big to be stored in a QR Code");if(!C)C=w;else if(C<w)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+w+`.
`);const E=A(C,v,P),b=n.getSymbolSize(C),L=new e(b);return g(L,C),N(L),B(L,C),T(L,v,0),C>=7&&I(L,C),x(L,E),isNaN(p)&&(p=a.getBestMask(L,T.bind(null,L,v))),a.applyMask(p,L),T(L,v,p),{modules:L,version:C,errorCorrectionLevel:v,maskPattern:p,segments:P}}return ae.create=function(C,v){if(typeof C>"u"||C==="")throw new Error("No input text");let p=r.M,P,w;return typeof v<"u"&&(p=r.from(v.errorCorrectionLevel,r.M),P=d.from(v.version),w=a.from(v.maskPattern),v.toSJISFunc&&n.setToSJISFunction(v.toSJISFunc)),R(C,P,p,w)},ae}var Pe={},Te={},st;function pt(){return st||(st=1,(function(n){function r(i){if(typeof i=="number"&&(i=i.toString()),typeof i!="string")throw new Error("Color should be defined as hex string");let e=i.slice().replace("#","").split("");if(e.length<3||e.length===5||e.length>8)throw new Error("Invalid hex color: "+i);(e.length===3||e.length===4)&&(e=Array.prototype.concat.apply([],e.map(function(o){return[o,o]}))),e.length===6&&e.push("F","F");const t=parseInt(e.join(""),16);return{r:t>>24&255,g:t>>16&255,b:t>>8&255,a:t&255,hex:"#"+e.slice(0,6).join("")}}n.getOptions=function(e){e||(e={}),e.color||(e.color={});const t=typeof e.margin>"u"||e.margin===null||e.margin<0?4:e.margin,o=e.width&&e.width>=21?e.width:void 0,a=e.scale||4;return{width:o,scale:o?4:a,margin:t,color:{dark:r(e.color.dark||"#000000ff"),light:r(e.color.light||"#ffffffff")},type:e.type,rendererOpts:e.rendererOpts||{}}},n.getScale=function(e,t){return t.width&&t.width>=e+t.margin*2?t.width/(e+t.margin*2):t.scale},n.getImageWidth=function(e,t){const o=n.getScale(e,t);return Math.floor((e+t.margin*2)*o)},n.qrToImageData=function(e,t,o){const a=t.modules.size,c=t.modules.data,s=n.getScale(a,o),d=Math.floor((a+o.margin*2)*s),f=o.margin*s,m=[o.color.light,o.color.dark];for(let h=0;h<d;h++)for(let g=0;g<d;g++){let N=(h*d+g)*4,B=o.color.light;if(h>=f&&g>=f&&h<d-f&&g<d-f){const I=Math.floor((h-f)/s),T=Math.floor((g-f)/s);B=m[c[I*a+T]?1:0]}e[N++]=B.r,e[N++]=B.g,e[N++]=B.b,e[N]=B.a}}})(Te)),Te}var ct;function Jt(){return ct||(ct=1,(function(n){const r=pt();function i(t,o,a){t.clearRect(0,0,o.width,o.height),o.style||(o.style={}),o.height=a,o.width=a,o.style.height=a+"px",o.style.width=a+"px"}function e(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}n.render=function(o,a,c){let s=c,d=a;typeof s>"u"&&(!a||!a.getContext)&&(s=a,a=void 0),a||(d=e()),s=r.getOptions(s);const f=r.getImageWidth(o.modules.size,s),m=d.getContext("2d"),h=m.createImageData(f,f);return r.qrToImageData(h.data,o,s),i(m,d,f),m.putImageData(h,0,0),d},n.renderToDataURL=function(o,a,c){let s=c;typeof s>"u"&&(!a||!a.getContext)&&(s=a,a=void 0),s||(s={});const d=n.render(o,a,s),f=s.type||"image/png",m=s.rendererOpts||{};return d.toDataURL(f,m.quality)}})(Pe)),Pe}var Ae={},lt;function jt(){if(lt)return Ae;lt=1;const n=pt();function r(t,o){const a=t.a/255,c=o+'="'+t.hex+'"';return a<1?c+" "+o+'-opacity="'+a.toFixed(2).slice(1)+'"':c}function i(t,o,a){let c=t+o;return typeof a<"u"&&(c+=" "+a),c}function e(t,o,a){let c="",s=0,d=!1,f=0;for(let m=0;m<t.length;m++){const h=Math.floor(m%o),g=Math.floor(m/o);!h&&!d&&(d=!0),t[m]?(f++,m>0&&h>0&&t[m-1]||(c+=d?i("M",h+a,.5+g+a):i("m",s,0),s=0,d=!1),h+1<o&&t[m+1]||(c+=i("h",f),f=0)):s++}return c}return Ae.render=function(o,a,c){const s=n.getOptions(a),d=o.modules.size,f=o.modules.data,m=d+s.margin*2,h=s.color.light.a?"<path "+r(s.color.light,"fill")+' d="M0 0h'+m+"v"+m+'H0z"/>':"",g="<path "+r(s.color.dark,"stroke")+' d="'+e(f,d,s.margin)+'"/>',N='viewBox="0 0 '+m+" "+m+'"',I='<svg xmlns="http://www.w3.org/2000/svg" '+(s.width?'width="'+s.width+'" height="'+s.width+'" ':"")+N+' shape-rendering="crispEdges">'+h+g+`</svg>
`;return typeof c=="function"&&c(null,I),I},Ae}var dt;function zt(){if(dt)return j;dt=1;const n=Pt(),r=Ht(),i=Jt(),e=jt();function t(o,a,c,s,d){const f=[].slice.call(arguments,1),m=f.length,h=typeof f[m-1]=="function";if(!h&&!n())throw new Error("Callback required as last argument");if(h){if(m<2)throw new Error("Too few arguments provided");m===2?(d=c,c=a,a=s=void 0):m===3&&(a.getContext&&typeof d>"u"?(d=s,s=void 0):(d=s,s=c,c=a,a=void 0))}else{if(m<1)throw new Error("Too few arguments provided");return m===1?(c=a,a=s=void 0):m===2&&!a.getContext&&(s=c,c=a,a=void 0),new Promise(function(g,N){try{const B=r.create(c,s);g(o(B,a,s))}catch(B){N(B)}})}try{const g=r.create(c,s);d(null,o(g,a,s))}catch(g){d(g)}}return j.create=r.create,j.toCanvas=t.bind(null,i.render),j.toDataURL=t.bind(null,i.renderToDataURL),j.toString=t.bind(null,function(o,a,c){return e.render(o,c)}),j}var Kt=zt();const Vt=kt(Kt),u={token:null,me:null,sabPage:1,sabPages:1,sabTimer:null,npTimer:null,apps:[],resetToken:null},l=n=>document.querySelector(n);function Q(){try{history.replaceState&&history.replaceState(null,"",location.pathname)}catch{}}function S(n,r="ok"){const i=l("#toasts"),e=document.createElement("div");e.className=`toast ${r==="ok"?"toast-ok":"toast-err"}`,e.textContent=n,i.appendChild(e),setTimeout(()=>e.remove(),3500)}function yt(){const n=u.me&&u.me.preferences&&u.me.preferences.theme||"dark";document.body.setAttribute("data-theme",n)}const Yt={open({title:n,bodyHTML:r,confirmText:i="Confirm",onConfirm:e,onOpen:t}){l("#modalTitle").textContent=n||"",l("#modalBody").innerHTML=r||"",l("#modalOk").textContent=i,l("#modal").classList.remove("hidden"),t&&t();const o=l("#modalOk"),a=l("#modalCancel"),c=()=>l("#modal").classList.add("hidden");a.onclick=c,o.onclick=async()=>{try{await e?.()}finally{c()}}}};function D(n){for(const i of["#view-login","#view-register","#view-forgot","#view-reset","#view-apps","#view-admin","#view-settings"]){const e=l(i);e&&e.classList.add("hidden")}const r=l(n);r&&r.classList.remove("hidden"),window.scrollTo({top:0,behavior:"smooth"})}const Qt=new URLSearchParams(location.search),ut=Qt.get("token");ut&&(u.resetToken=ut,D("#view-reset"));function X(n){if(n==null||!isFinite(n))return"0:00";n=Math.max(0,Math.floor(n));const r=Math.floor(n/3600),i=Math.floor(n%3600/60),e=n%60;return(r?`${r}:${String(i).padStart(2,"0")}`:`${i}`)+`:${String(e).padStart(2,"0")}`}async function M(n,r={}){const i=await fetch(n,Object.assign({headers:{"Content-Type":"application/json",...u.token?{Authorization:"Bearer "+u.token}:{}}},r)),e=i.headers.get("content-type")||"",t=await i.text();let o;if(e.includes("application/json"))try{o=JSON.parse(t)}catch{throw{error:"Invalid JSON from server",raw:t}}else throw{error:`Bad response (${i.status})`,body:t.slice(0,200)};if(!i.ok)throw o;return o}l("#brandLink").onclick=n=>{n.preventDefault(),u.token?D("#view-apps"):D("#view-login")};document.addEventListener("click",n=>{const r=n.target.closest(".tab");if(!r)return;document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),r.classList.add("active");const i=r.dataset.tab;["apps","users","invites","news"].forEach(e=>l("#tab-"+e)?.classList.toggle("hidden",e!==i))});function wt(n,r){const i=l(n);if(!i)return;i.innerHTML="";const e=document.createElement("canvas");e.width=240,e.height=240,i.appendChild(e),Vt.toCanvas(e,r,{width:240,margin:1,color:{dark:"#000",light:"#fff"}},t=>{t&&console.error(t)})}async function bt(){const n=document.getElementById("newsSection"),r=n?.querySelector(".news-grid");if(!(!n||!r))try{const e=await(await fetch("/api/news")).json();if(e.enabled===!1){n.classList.add("hidden"),r.innerHTML="";return}if(n.classList.remove("hidden"),r.innerHTML="",!(e.items&&e.items.length)){r.innerHTML='<p class="text-sm text-neutral-300">No news available.</p>';return}e.items.forEach((t,o)=>{const a=document.createElement("article");if(a.className="news-item"+(o===0?" large":""),t.image){const s=document.createElement("img");s.src=t.image,s.alt=t.title,a.appendChild(s)}const c=document.createElement("h4");c.textContent=t.title,a.appendChild(c),a.onclick=()=>window.open(t.link,"_blank"),r.appendChild(a)})}catch(i){console.error("Failed to load news",i),n.classList.remove("hidden"),r.innerHTML='<p class="text-sm text-neutral-300">Failed to load news.</p>'}}async function Y(n){try{await navigator.clipboard.writeText(n)}catch{const r=document.createElement("textarea");r.value=n,document.body.appendChild(r),r.select(),document.execCommand("copy"),r.remove()}S("Copied to clipboard")}(function(){const n=localStorage.getItem("zm_token");n&&(u.token=n,M("/api/me").then(r=>(u.me=r.user,Q(),Ie(!1))).catch(()=>{localStorage.removeItem("zm_token"),u.token=null}))})();document.getElementById("loginForm").addEventListener("submit",async n=>{n.preventDefault();const r=l("#loginError");r&&(r.textContent="");const i=new FormData(n.target),e=!!i.get("remember"),t={username:i.get("username"),password:i.get("password"),remember:e},o=i.get("otp");o&&(t.otp=o);try{const{token:a,user:c}=await M("/api/login",{method:"POST",body:JSON.stringify(t)});u.token=a,u.me=c,e?localStorage.setItem("zm_token",a):localStorage.removeItem("zm_token"),Q(),await Ie()}catch(a){if(a&&a.error==="MFA code required"){const c=l("#otpWrap");c&&(c.classList.remove("hidden"),c.querySelector('input[name="otp"]').focus());return}(r||{}).textContent=a&&(a.error||a.message)?a.error||a.message:"Login failed"}});l("#btn-register").onclick=n=>{n.preventDefault(),D("#view-register")};l("#btn-forgot").onclick=n=>{n.preventDefault(),D("#view-forgot")};document.getElementById("registerForm").addEventListener("submit",async n=>{n.preventDefault();const r=new FormData(n.target),i=(r.get("username")||"").trim(),e=r.get("password"),t=(r.get("email")||"").trim().toLowerCase(),o={inviteCode:r.get("inviteCode"),username:i,password:e,email:t,enableTotp:!!r.get("enableTotp")};try{const{otpauth:a,secret:c}=await M("/api/register",{method:"POST",body:JSON.stringify(o)});if(a){const s=c||(()=>{try{const m=new URL(a);return new URLSearchParams(m.search).get("secret")||""}catch{}return""})();n.target.classList.add("hidden"),l("#registerMfa").classList.remove("hidden"),l("#otpauth").textContent=a,l("#otpsecret").textContent=s,l("#copyOtpauth").onclick=()=>Y(a),l("#copySecret").onclick=()=>Y(s);try{wt("#qr",a)}catch(m){console.error(m)}const f=l("#registerOtp");l("#registerVerify").onclick=async()=>{const m=(f.value||"").trim();if(!/^[0-9]{6}$/.test(m))return S("Enter the 6‑digit code from your app","err");try{const{token:h,user:g}=await M("/api/login",{method:"POST",body:JSON.stringify({username:i,password:e,otp:m})});u.token=h,u.me=g,localStorage.setItem("zm_token",h),Q(),S("Account created!"),Ie()}catch(h){S(h.error||"Invalid or expired MFA code","err")}}}else S("Account created! You can now sign in."),D("#view-login")}catch(a){S(a.error||"Registration failed","err")}});l("#btn-register-back").onclick=n=>{n.preventDefault(),D("#view-login")};document.getElementById("forgotForm").addEventListener("submit",async n=>{n.preventDefault();const i=(new FormData(n.target).get("email")||"").trim().toLowerCase();try{await M("/api/forgot-password",{method:"POST",body:JSON.stringify({email:i})}),S("If the email exists, a reset link has been sent."),D("#view-login")}catch(e){S(e.error||"Request failed","err")}});l("#btn-forgot-back").onclick=n=>{n.preventDefault(),D("#view-login")};document.getElementById("resetForm").addEventListener("submit",async n=>{n.preventDefault();const r=new FormData(n.target);try{await M("/api/reset",{method:"POST",body:JSON.stringify({token:u.resetToken,newPassword:r.get("password")})}),S("Password updated. Sign in."),Q(),D("#view-login")}catch(i){S(i.error||"Reset failed","err")}});l("#btn-reset-back").onclick=n=>{n.preventDefault(),Q(),D("#view-login")};function vt(n){const r=(n.firstName||"").trim(),i=(n.lastName||"").trim(),e=(n.username||"").trim();return(r||i)&&((r[0]||"")+(i[0]||"")).toUpperCase()||(e[0]||"?").toUpperCase()}async function Ie(n){const r=u.me||(await M("/api/me")).user;u.me=r,yt(),l("#navArea").classList.remove("hidden");const i=[u.me.firstName,u.me.lastName].filter(Boolean).join(" ")||u.me.username||"";l("#userName").textContent=i;const e=l("#userAvatar"),t=l("#userInitial");u.me.profileImage?(e.src=u.me.profileImage,e.classList.remove("hidden"),t.classList.add("hidden")):(t.textContent=vt(u.me),t.classList.remove("hidden"),e.classList.add("hidden")),u.me.role==="admin"&&l("#ddAdmin").classList.remove("hidden");const o=l("#userMenu"),a=l("#userBtn");a.onclick=d=>{d.preventDefault(),o.classList.toggle("open")},document.addEventListener("click",d=>{o.contains(d.target)||o.classList.remove("open")}),l("#ddSettings").onclick=()=>{rn(),D("#view-settings"),o.classList.remove("open")},l("#ddAdmin").onclick=()=>{D("#view-admin"),o.classList.remove("open")},l("#ddLogout").onclick=async()=>{await M("/api/logout",{method:"POST"}),localStorage.removeItem("zm_token"),location.reload()};const c=l("#prefNPRow"),s=l("#prefShowNP");if(u.me.role==="admin"){c.classList.remove("hidden");const d=u.me.preferences&&"showNowPlaying"in u.me.preferences?!!u.me.preferences.showNowPlaying:!0;s.checked=d}else c.classList.add("hidden");await Ne(),ee(),u.sabPage=1,Xt(),tn(),Me(),bt(),n||D("#view-apps")}function Gt(n,r){if(!Array.isArray(r)||!r.length)return n.slice();const i=new Map(r.map((e,t)=>[e,t]));return n.slice().sort((e,t)=>{const o=i.has(e.key)?i.get(e.key):1/0,a=i.has(t.key)?i.get(t.key):1/0;return o!==a?o-a:(e.name||"").localeCompare(t.name||"")})}async function Wt(n){try{await M("/api/me",{method:"PUT",body:JSON.stringify({appOrder:n})}),u.me.preferences=u.me.preferences||{},u.me.preferences.appOrder=n.slice(),S("App order saved")}catch(r){S(r.error||"Failed to save order","err")}}async function Ne(){const{apps:n}=await M("/api/apps"),r=u.me.role==="admin"?n:n.filter(e=>!e.hidden&&!e._hidden),i=u.me.preferences&&Array.isArray(u.me.preferences.appOrder)?u.me.preferences.appOrder:[];if(u.apps=Gt(r,i),u.me.role==="admin"){const e=l("#appsEditor");if(e){const a=c=>{e.className="apps-grid",e.innerHTML="";for(const s of c){const d=document.createElement("div");d.className="app-card rounded-xl bg-white/5 border border-white/10 p-3",d.innerHTML=`
                <div class="flex items-center justify-between gap-3">
                  <div class="flex items-center gap-3 min-w-0">
                    <img id="logoPreview-${s.key}" src="${s.logo||""}" onerror="this.src='';this.classList.add('opacity-40');" class="h-10 w-10 object-contain rounded bg-white/10 p-1" alt="logo" />
                    <div class="min-w-0">
                      <div class="text-base font-semibold truncate">${s.name||"(unnamed app)"}</div>
                      <div class="text-xs text-neutral-300 truncate">${s.url||""}</div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <label class="text-xs flex items-center gap-2 select-none">
                      <input data-k="hidden" data-key="${s.key}" type="checkbox" ${s.hidden?"checked":""}/>
                      <span>Hide</span>
                    </label>
                    <button class="px-2 py-1 bg-red-700/80 rounded text-xs" data-del="${s.key}">Delete</button>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                  <div>
                    <label class="block text-xs mb-1">Name</label>
                    <input data-k="name" data-key="${s.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${s.name||""}">
                  </div>
                  <div>
                    <label class="block text-xs mb-1">App URL</label>
                    <input data-k="url" data-key="${s.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${s.url||""}">
                  </div>
                  <div>
                    <label class="block text-xs mb-1">Logo URL</label>
                    <input data-k="logo" data-key="${s.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${s.logo||""}">
                  </div>
                </div>`,e.appendChild(d)}e.querySelectorAll('input[data-k="logo"]').forEach(s=>{s.addEventListener("input",d=>{const f=d.target.getAttribute("data-key"),m=document.getElementById("logoPreview-"+f);m&&(m.src=d.target.value.trim())})}),e.querySelectorAll("button[data-del]").forEach(s=>{s.onclick=()=>{const d=s.getAttribute("data-del"),m=e.querySelector(`input[data-k="name"][data-key="${d}"]`)?.value?.trim()||"";Yt.open({title:"Delete App",bodyHTML:'Are you sure you want to delete "<span id="delAppName"></span>"?',confirmText:"Delete",onOpen:()=>{l("#delAppName").textContent=m},onConfirm:async()=>{try{await M("/api/apps/"+encodeURIComponent(d),{method:"DELETE"}),S("App deleted"),await Ne(),ee()}catch(h){S(h.error||"Delete failed","err")}}})}})};a(n),l("#addApp").onclick=()=>{const c={key:Zt(),name:"",url:"",logo:"",hidden:!1};n.push(c),a(n),S('New app row added. Fill fields and click "Save Apps".')},l("#saveApps").onclick=async()=>{const c=n.map(s=>({...s}));document.querySelectorAll("#appsEditor [data-k]").forEach(s=>{const d=s.getAttribute("data-k"),f=s.getAttribute("data-key"),m=c.find(h=>h.key===f);m&&(d==="hidden"?m.hidden=s.checked:m[d]=s.value.trim())});for(const s of c)if(!s.name||!s.url){S("Each app needs at least a Name and URL","err");return}await M("/api/apps",{method:"PUT",body:JSON.stringify({apps:c})}),S("Apps saved"),await Ne(),ee()}}try{const a=await M("/api/sab");l("#sabBaseUrl").value=a.sab.baseUrl||"",l("#sabApiKey").value=a.sab.apiKey||"";const c=l("#saveSab");c&&(c.onclick=async()=>{await M("/api/sab",{method:"PUT",body:JSON.stringify({baseUrl:l("#sabBaseUrl").value.trim(),apiKey:l("#sabApiKey").value.trim()})}),S("SAB settings saved"),l("#testSab")?.click()});const s=l("#testSab");s&&(s.onclick=async()=>{try{const d=await M("/api/sab/test");d.ok?S("SAB connection successful"):S(`SAB test failed (status ${d.status})`,"err")}catch(d){S(d.error||"SAB test failed","err")}})}catch{}try{const a=await M("/api/plex");if(a&&a.plex){const d=l("#plexToken"),f=l("#plexBaseUrl");d&&(d.value=a.plex.token||""),f&&(f.value=a.plex.baseUrl||"")}const c=l("#savePlex");c&&(c.onclick=async()=>{const d=(l("#plexToken")?.value||"").trim();let f=(l("#plexBaseUrl")?.value||"").trim();await M("/api/plex",{method:"PUT",body:JSON.stringify({baseUrl:f,token:d})}),S("Plex settings saved"),l("#testPlex")?.click()});const s=l("#testPlex");s&&(s.onclick=async()=>{try{const d=await M("/api/plex/test");d.ok?S("Plex connection successful"):S(`Plex test failed (status ${d.status})`,"err")}catch(d){S(d.error||"Plex test failed","err")}})}catch{}let t={enabled:!0,market:"en-us"};try{t=(await M("/api/msn")).msn||t}catch{}l("#newsEnabled").checked=!!t.enabled,l("#newsMarket").value=t.market||"";const o=l("#saveNews");o&&(o.onclick=async()=>{await M("/api/msn",{method:"PUT",body:JSON.stringify({enabled:l("#newsEnabled").checked,market:l("#newsMarket").value.trim()})}),S("News settings saved"),bt()});try{const a=await M("/api/smtp");l("#smtpHost").value=a.smtp.host||"",l("#smtpPort").value=a.smtp.port||"",l("#smtpUser").value=a.smtp.user||"",l("#smtpFrom").value=a.smtp.from||"",l("#smtpSecure").checked=a.smtp.secure||!1;const c=l("#saveSmtp");c&&(c.onclick=async()=>{await M("/api/smtp",{method:"PUT",body:JSON.stringify({host:l("#smtpHost").value.trim(),port:Number(l("#smtpPort").value.trim()||"587"),user:l("#smtpUser").value.trim(),pass:l("#smtpPass").value,from:l("#smtpFrom").value.trim(),secure:l("#smtpSecure").checked})}),S("SMTP settings saved")});const s=l("#testSmtp");s&&(s.onclick=async()=>{try{(await M("/api/smtp/test")).ok?S("Test email sent"):S("SMTP test failed","err")}catch(d){S(d.error||"SMTP test failed","err")}})}catch{}await Le(),await V()}}function Zt(){return Math.random().toString(16).slice(2,10)}async function Le(){const n=l("#usersList");if(!n)return;const r=await M("/api/users"),i=r.users.filter(e=>e.role==="admin").length;n.innerHTML="";for(const e of r.users){const t=document.createElement("div");t.className="bg-white/5 border border-white/10 rounded p-3";const o=((e.firstName||"")[0]||"")+((e.lastName||"")[0]||""),a=e.profileImage?`<img src="${e.profileImage}" class="h-8 w-8 rounded-full object-cover mr-2" alt="avatar" />`:`<span class="mr-2 inline-flex items-center justify-center h-8 w-8 rounded-full text-sm font-semibold" style="background:linear-gradient(135deg, rgba(253,81,58,.9), rgba(44,83,216,.85));">${(o||e.username||"?").slice(0,2).toUpperCase()}</span>`,c=[e.firstName,e.lastName].filter(Boolean).join(" ")||e.username;t.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="text-sm flex items-center">
              ${a}
              <span class="font-semibold truncate max-w-[40vw]">${c}</span>
              <span class="text-neutral-300 ml-2">(${e.role})</span>
            </div>
            <div class="flex gap-2">
              <button type="button" data-act="promote" class="px-2 py-1 bg-white/10 rounded">Toggle Admin</button>
              <button type="button" data-act="delete" class="px-2 py-1 bg-red-700/80 rounded">Delete</button>
            </div>
          </div>`;const s=t.querySelector('[data-act="promote"]');s.disabled=i<=1&&e.role==="admin",s.classList.toggle("opacity-50",s.disabled),s.onclick=async()=>{const d=e.role==="admin"?"user":"admin";try{await M(`/api/users/${e.username}`,{method:"PATCH",body:JSON.stringify({role:d})}),S("Role updated"),await Le()}catch(f){S(f.error||"Update failed","err")}},t.querySelector('[data-act="delete"]').onclick=async()=>{if(confirm(`Delete user ${e.username}? This cannot be undone.`))try{await M(`/api/users/${encodeURIComponent(e.username)}`,{method:"DELETE"}),S("User deleted"),await Le()}catch(d){S(d.error||"Delete failed","err")}},n.appendChild(t)}}async function V(){const n=l("#invList");if(!n)return;const i=(await M("/api/invites")).invites.sort((e,t)=>(t.createdAt||"").localeCompare(e.createdAt||"")).map(e=>`<tr class="border-t border-white/10"><td class="py-2 pr-2 mono">${e.code}</td><td>${e.role}</td><td>${e.createdBy||""}</td><td>${e.createdAt||""}</td><td>${e.expiresAt||"never"}</td><td>${e.usedBy||""}</td><td>${e.usedAt||""}</td><td class="text-right"><button data-code="${e.code}" class="px-2 py-1 bg-white/10 rounded copy">Copy</button><button data-code="${e.code}" class="ml-2 px-2 py-1 bg-red-700/80 rounded del">Delete</button></td></tr>`).join("");n.innerHTML=`<table class="w-full text-sm"><thead class="text-neutral-300"><tr><th class="text-left py-2">Code</th><th class="text-left">Role</th><th class="text-left">Created by</th><th class="text-left">Created at</th><th class="text-left">Expires</th><th class="text-left">Used by</th><th class="text-left">Used at</th><th class="text-right">Actions</th></tr></thead><tbody>${i||'<tr><td class="py-2 text-neutral-300" colspan="8">No invites</td></tr>'}</tbody></table>`,n.querySelectorAll(".copy").forEach(e=>e.onclick=()=>Y(e.dataset.code)),n.querySelectorAll(".del").forEach(e=>e.onclick=async()=>{confirm(`Delete invite ${e.dataset.code}?`)&&(await M(`/api/invites/${e.dataset.code}`,{method:"DELETE"}),S("Invite deleted"),await V())}),l("#invCreate").onclick=async()=>{const e=l("#invRole").value||"user",t=(()=>{const c=l("#invPreset").value;if(c==="never")return null;const s=new Date;return c==="1d"&&s.setDate(s.getDate()+1),c==="7d"&&s.setDate(s.getDate()+7),c==="1m"&&s.setMonth(s.getMonth()+1),c==="6m"&&s.setMonth(s.getMonth()+6),s.toISOString()})(),o=(l("#invEmail")?.value||"").trim(),a=await M("/api/invites",{method:"POST",body:JSON.stringify({role:e,expiresAt:t,email:o||void 0})});S(`Invite created: ${a.code}${a.emailSent?" (email sent)":""}`),l("#invEmail")&&(l("#invEmail").value=""),await V()},l("#eraseUsedInvites").onclick=async()=>{confirm("Erase USED invites from history? This cannot be undone.")&&(await M("/api/invites/erase-history",{method:"POST",body:JSON.stringify({includeUnused:!1})}),S("Used invite history cleared"),await V())},l("#eraseAllInvites").onclick=async()=>{confirm("Erase ALL invites? This cannot be undone.")&&(await M("/api/invites/erase-history",{method:"POST",body:JSON.stringify({includeUnused:!0})}),S("All invites cleared"),await V())}}function ee(){const n=l("#tiles");if(n){n.innerHTML="";for(const r of u.apps){const i=document.createElement("a");i.href=r.url,i.target="_blank",i.className="tile glass rounded-2xl p-4 flex items-center gap-4 no-underline text-inherit",i.setAttribute("draggable","true"),i.dataset.key=r.key,i.innerHTML=`<img src="${r.logo}" class="h-10 w-10 object-contain" alt="${r.name}"><div><div class="font-semibold">${r.name}</div><div class="text-xs text-neutral-300">${r.url}</div></div>`,i.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/app-key",r.key),e.dataTransfer.effectAllowed="move",i.classList.add("ring-2","ring-white/30")}),i.addEventListener("dragend",()=>{i.classList.remove("ring-2","ring-white/30")}),i.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),i.addEventListener("drop",async e=>{e.preventDefault();const t=e.dataTransfer.getData("text/app-key"),o=i.dataset.key;if(!t||t===o)return;const a=u.apps.map(f=>f.key),c=a.indexOf(t),s=a.indexOf(o);if(c<0||s<0)return;const d=u.apps.splice(c,1)[0];u.apps.splice(s,0,d),ee(),await Wt(u.apps.map(f=>f.key))}),n.appendChild(i)}if(!localStorage.getItem("zm_dnd_hint")){const r=document.createElement("div");r.className="text-xs text-neutral-300 mt-2",r.textContent="Tip: Drag tiles to rearrange. Your layout is saved to your account.",n.parentElement.appendChild(r),localStorage.setItem("zm_dnd_hint","1")}}}async function Z(n){try{const r=await M(`/api/sab/queue?page=${n}`);u.sabPage=r.page,u.sabPages=r.pages||1;const i=l("#sabRows"),e=(r.slots||[]).map(s=>{const d=Math.max(0,Math.min(100,Number(s.percentage||0)));return`<tr class="border-t border-white/10"><td class="py-2 pr-2">${s.filename}</td><td>${s.status}</td><td class="w-56"><div class="relative bar h-5"><span style="width:${d}%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">${d}%</div></div></td><td class="text-right">${s.timeleft||""}</td></tr>`}).join("");i.innerHTML=e||'<tr class="border-t border-white/10"><td class="py-2 pr-2 text-neutral-300">–</td><td class="text-neutral-300">–</td><td class="w-56"><div class="relative bar h-5"><span style="width:0%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">0%</div></div></td><td class="text-right text-neutral-300">–</td></tr>';const t=r.speedText||(r.speed?r.speed>=1024?(r.speed/1024).toFixed(2)+" MB/s":r.speed.toFixed(0)+" KB/s":"0 KB/s");l("#sabStatus").textContent=`Speed: ${t}${r.paused?" (paused)":""}`;const o=l("#sabPage"),a=l("#sabPrev"),c=l("#sabNext");u.sabPages>1?(o.textContent=`Page ${u.sabPage} / ${u.sabPages}`,a.disabled=u.sabPage<=1,c.disabled=u.sabPage>=u.sabPages,a.classList.toggle("opacity-50",a.disabled),c.classList.toggle("opacity-50",c.disabled),o.parentElement.classList.remove("hidden")):o.parentElement.classList.add("hidden")}catch{l("#sabRows").innerHTML='<tr class="border-t border-white/10"><td class="py-2 pr-2 text-neutral-300">–</td><td class="text-neutral-300">–</td><td class="w-56"><div class="relative bar h-5"><span style="width:0%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">0%</div></div></td><td class="text-right text-neutral-300">–</td></tr>',l("#sabStatus").textContent="";const r=l("#sabPage")?.parentElement;r&&r.classList.add("hidden")}}function Xt(){clearInterval(u.sabTimer),(typeof u.sabPage!="number"||u.sabPage<1)&&(u.sabPage=1),Z(u.sabPage),u.sabTimer=setInterval(()=>Z(u.sabPage),3e3),l("#sabPrev").onclick=()=>{u.sabPage>1&&(u.sabPage--,Z(u.sabPage))},l("#sabNext").onclick=()=>{u.sabPages&&u.sabPage<u.sabPages&&(u.sabPage++,Z(u.sabPage))}}function Be(){return!u.me||u.me.role!=="admin"?!1:(u.me.preferences||{}).showNowPlaying!==!1}async function ft(){try{const n=await M("/api/now-playing"),r=Array.isArray(n)?n:n.sessions||[],i=l("#nowPlayingWrap"),e=l("#nowPlaying"),t=l("#npMeta");if(!Be()){i.classList.add("hidden");return}if(i.classList.remove("hidden"),window.__npSampledAt=Date.now(),t.textContent=r.length?`${r.length} active session${r.length>1?"s":""}`:"",!r.length){e.innerHTML='<div class="text-sm text-neutral-300">No one is watching right now.</div>';return}e.innerHTML=r.map(o=>{const a=typeof o.viewOffsetMs=="number"?o.viewOffsetMs:typeof o.viewOffset=="number"?o.viewOffset:null,c=typeof o.durationMs=="number"?o.durationMs:typeof o.duration=="number"?o.duration:null,s=a!=null?a/1e3:null,d=c!=null?c/1e3:null,f=s!=null&&d>0?Math.max(0,Math.min(100,s/d*100)):null,m=f??Math.max(0,Math.min(100,Number(o.progress||0))),h=o.user||"Unknown",g=o.title||"",N=o.quality?` • ${o.quality}`:"",B=o.state==="paused"?" (paused)":"",I=s!=null&&d>0?`${X(s)} / ${X(d)}`:`${m.toFixed(0)}%`;return`<div class="flex items-center justify-between py-2 border-t border-white/10" data-npid="${(o.id||g+h).toString().replace(/"/g,"")}" data-duration="${c||""}" data-offset="${a||""}" data-state="${o.state||""}"><div class="min-w-0 pr-4"><div class="font-semibold truncate">${h}${B}</div><div class="text-xs text-neutral-300 truncate">${g}${N}${o.device?` • ${o.device}`:""}</div></div><div class="w-56"><div class="relative bar h-4"><span style="width:${m}%"></span><div class="absolute inset-0 flex items-center justify-center text-[10px]" data-role="np-time">${I}</div></div></div></div>`}).join(""),en()}catch{const r=l("#nowPlayingWrap");Be()?(r.classList.remove("hidden"),l("#nowPlaying").innerHTML='<div class="text-sm text-red-300">Now Playing unavailable.</div>',l("#npMeta").textContent=""):r.classList.add("hidden")}}function en(){try{u.npClock&&clearInterval(u.npClock),u.npClock=setInterval(()=>{const n=window.__npSampledAt||Date.now(),r=Date.now()-n;document.querySelectorAll("#nowPlaying [data-duration]").forEach(i=>{const e=Number(i.getAttribute("data-duration")||0);let t=Number(i.getAttribute("data-offset")||0);const o=(i.getAttribute("data-state")||"").toLowerCase();if(!e||e<=0)return;o!=="paused"&&(t=t+r);const a=Math.max(0,Math.min(e,t))/1e3,c=e/1e3,s=Math.max(0,Math.min(100,a/c*100)),d=i.querySelector(".bar span");d&&(d.style.width=s+"%");const f=i.querySelector('[data-role="np-time"]');f&&(f.textContent=`${X(a)} / ${X(c)}`)})},1e3)}catch{}}function tn(){if(clearInterval(u.npTimer),!Be()){l("#nowPlayingWrap").classList.add("hidden");return}ft(),u.npTimer=setInterval(ft,5e3)}function nn(){return!!(u.me&&u.me.totpSecret)}async function Me(){if(!l("#mfaBox"))return;const r=nn();l("#mfaStatus").textContent=r?"Enabled":"Disabled",l("#mfaStart").classList.toggle("hidden",r),l("#mfaDisable").classList.toggle("hidden",!r),l("#mfaSetup").classList.add("hidden"),l("#mfaStart").onclick=async()=>{try{const i=await M("/api/me",{method:"PUT",body:JSON.stringify({mfaAction:"start"})});if(i.otpauth){const e=i.secret||(()=>{try{const t=new URL(i.otpauth);return new URLSearchParams(t.search).get("secret")||""}catch{}return""})();l("#mfaSetup").classList.remove("hidden"),l("#mfaOtpauth").textContent=i.otpauth,l("#mfaSecret").textContent=e,l("#mfaCopyLink").onclick=()=>Y(i.otpauth),l("#mfaCopySecret").onclick=()=>Y(e);try{wt("#mfaQr",i.otpauth)}catch(t){console.error(t)}u.me=i.user||u.me}}catch(i){S(i.error||"Failed to start setup","err")}},l("#mfaDisable").onclick=async()=>{if(confirm("Disable authenticator app for this account?"))try{const i=await M("/api/me",{method:"PUT",body:JSON.stringify({mfaAction:"disable"})});u.me=i.user,S("MFA disabled"),Me()}catch(i){S(i.error||"Failed to disable","err")}},l("#mfaVerify").onclick=async()=>{const i=l("#mfaCode").value.trim();if(!/^[0-9]{6}$/.test(i)){S("Enter the 6‑digit code from your app","err");return}try{const e=await M("/api/me",{method:"PUT",body:JSON.stringify({mfaAction:"verify",code:i})});u.me=e.user,S("MFA enabled and saved"),Me()}catch(e){S(e.error||"Invalid or expired MFA code","err")}}}function rn(){const n=document.getElementById("meForm");if(!n||!u.me)return;n.username.value="",n.password.value="",n.firstName.value=u.me.firstName||"",n.lastName.value=u.me.lastName||"";const r=l("#prefTheme");r&&(r.value=u.me.preferences&&u.me.preferences.theme||"dark")}document.getElementById("meForm").addEventListener("submit",async n=>{n.preventDefault();const r=new FormData(n.target),i={username:r.get("username")||void 0,password:r.get("password")||void 0,firstName:(r.get("firstName")||"").trim(),lastName:(r.get("lastName")||"").trim()},e=Object.assign({},u.me.preferences||{}),t=l("#prefTheme");t&&(e.theme=t.value);const o=l("#prefShowNP");if(o&&u.me&&u.me.role==="admin"&&(e.showNowPlaying=!!o.checked),i.preferences=e,l("#pfp")&&l("#pfp").files[0]){const a=l("#pfp").files[0];i.profileImage=await new Promise((c,s)=>{const d=new FileReader;d.onload=()=>c(d.result),d.onerror=s,d.readAsDataURL(a)})}try{const a=await M("/api/me",{method:"PUT",body:JSON.stringify(i)});u.me=a.user,yt(),S("Saved.");const c=[u.me.firstName,u.me.lastName].filter(Boolean).join(" ")||u.me.username;l("#userName").textContent=c;const s=l("#userAvatar"),d=l("#userInitial");u.me.profileImage?(s.src=u.me.profileImage,s.classList.remove("hidden"),d.classList.add("hidden")):(d.textContent=vt(u.me),d.classList.remove("hidden"),s.classList.add("hidden"))}catch(a){S(a.error||"Save failed","err")}});l("#btn-admin-close").onclick=()=>D("#view-apps");l("#btn-settings-close").onclick=()=>D("#view-apps");document.getElementById("year").textContent=new Date().getFullYear();
