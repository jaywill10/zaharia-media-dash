(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(t){if(t.ep)return;t.ep=!0;const n=i(t);fetch(t.href,n)}})();function St(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var z={},ie,$e;function Pt(){return $e||($e=1,ie=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}),ie}var ae={},O={},qe;function _(){if(qe)return O;qe=1;let r;const o=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];return O.getSymbolSize=function(e){if(!e)throw new Error('"version" cannot be null or undefined');if(e<1||e>40)throw new Error('"version" should be in range from 1 to 40');return e*4+17},O.getSymbolTotalCodewords=function(e){return o[e]},O.getBCHDigit=function(i){let e=0;for(;i!==0;)e++,i>>>=1;return e},O.setToSJISFunction=function(e){if(typeof e!="function")throw new Error('"toSJISFunc" is not a valid function.');r=e},O.isKanjiModeEnabled=function(){return typeof r<"u"},O.toSJIS=function(e){return r(e)},O}var se={},Fe;function Ie(){return Fe||(Fe=1,(function(r){r.L={bit:1},r.M={bit:0},r.Q={bit:3},r.H={bit:2};function o(i){if(typeof i!="string")throw new Error("Param is not a string");switch(i.toLowerCase()){case"l":case"low":return r.L;case"m":case"medium":return r.M;case"q":case"quartile":return r.Q;case"h":case"high":return r.H;default:throw new Error("Unknown EC Level: "+i)}}r.isValid=function(e){return e&&typeof e.bit<"u"&&e.bit>=0&&e.bit<4},r.from=function(e,t){if(r.isValid(e))return e;try{return o(e)}catch{return t}}})(se)),se}var ce,Oe;function kt(){if(Oe)return ce;Oe=1;function r(){this.buffer=[],this.length=0}return r.prototype={get:function(o){const i=Math.floor(o/8);return(this.buffer[i]>>>7-o%8&1)===1},put:function(o,i){for(let e=0;e<i;e++)this.putBit((o>>>i-e-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(o){const i=Math.floor(this.length/8);this.buffer.length<=i&&this.buffer.push(0),o&&(this.buffer[i]|=128>>>this.length%8),this.length++}},ce=r,ce}var le,_e;function At(){if(_e)return le;_e=1;function r(o){if(!o||o<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=o,this.data=new Uint8Array(o*o),this.reservedBit=new Uint8Array(o*o)}return r.prototype.set=function(o,i,e,t){const n=o*this.size+i;this.data[n]=e,t&&(this.reservedBit[n]=!0)},r.prototype.get=function(o,i){return this.data[o*this.size+i]},r.prototype.xor=function(o,i,e){this.data[o*this.size+i]^=e},r.prototype.isReserved=function(o,i){return this.reservedBit[o*this.size+i]},le=r,le}var de={},He;function Tt(){return He||(He=1,(function(r){const o=_().getSymbolSize;r.getRowColCoords=function(e){if(e===1)return[];const t=Math.floor(e/7)+2,n=o(e),a=n===145?26:Math.ceil((n-13)/(2*t-2))*2,s=[n-7];for(let c=1;c<t-1;c++)s[c]=s[c-1]-a;return s.push(6),s.reverse()},r.getPositions=function(e){const t=[],n=r.getRowColCoords(e),a=n.length;for(let s=0;s<a;s++)for(let c=0;c<a;c++)s===0&&c===0||s===0&&c===a-1||s===a-1&&c===0||t.push([n[s],n[c]]);return t}})(de)),de}var ue={},Je;function Nt(){if(Je)return ue;Je=1;const r=_().getSymbolSize,o=7;return ue.getPositions=function(e){const t=r(e);return[[0,0],[t-o,0],[0,t-o]]},ue}var fe={},ze;function Lt(){return ze||(ze=1,(function(r){r.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const o={N1:3,N2:3,N3:40,N4:10};r.isValid=function(t){return t!=null&&t!==""&&!isNaN(t)&&t>=0&&t<=7},r.from=function(t){return r.isValid(t)?parseInt(t,10):void 0},r.getPenaltyN1=function(t){const n=t.size;let a=0,s=0,c=0,d=null,f=null;for(let p=0;p<n;p++){s=c=0,d=f=null;for(let m=0;m<n;m++){let g=t.get(p,m);g===d?s++:(s>=5&&(a+=o.N1+(s-5)),d=g,s=1),g=t.get(m,p),g===f?c++:(c>=5&&(a+=o.N1+(c-5)),f=g,c=1)}s>=5&&(a+=o.N1+(s-5)),c>=5&&(a+=o.N1+(c-5))}return a},r.getPenaltyN2=function(t){const n=t.size;let a=0;for(let s=0;s<n-1;s++)for(let c=0;c<n-1;c++){const d=t.get(s,c)+t.get(s,c+1)+t.get(s+1,c)+t.get(s+1,c+1);(d===4||d===0)&&a++}return a*o.N2},r.getPenaltyN3=function(t){const n=t.size;let a=0,s=0,c=0;for(let d=0;d<n;d++){s=c=0;for(let f=0;f<n;f++)s=s<<1&2047|t.get(d,f),f>=10&&(s===1488||s===93)&&a++,c=c<<1&2047|t.get(f,d),f>=10&&(c===1488||c===93)&&a++}return a*o.N3},r.getPenaltyN4=function(t){let n=0;const a=t.data.length;for(let c=0;c<a;c++)n+=t.data[c];return Math.abs(Math.ceil(n*100/a/5)-10)*o.N4};function i(e,t,n){switch(e){case r.Patterns.PATTERN000:return(t+n)%2===0;case r.Patterns.PATTERN001:return t%2===0;case r.Patterns.PATTERN010:return n%3===0;case r.Patterns.PATTERN011:return(t+n)%3===0;case r.Patterns.PATTERN100:return(Math.floor(t/2)+Math.floor(n/3))%2===0;case r.Patterns.PATTERN101:return t*n%2+t*n%3===0;case r.Patterns.PATTERN110:return(t*n%2+t*n%3)%2===0;case r.Patterns.PATTERN111:return(t*n%3+(t+n)%2)%2===0;default:throw new Error("bad maskPattern:"+e)}}r.applyMask=function(t,n){const a=n.size;for(let s=0;s<a;s++)for(let c=0;c<a;c++)n.isReserved(c,s)||n.xor(c,s,i(t,c,s))},r.getBestMask=function(t,n){const a=Object.keys(r.Patterns).length;let s=0,c=1/0;for(let d=0;d<a;d++){n(d),r.applyMask(d,t);const f=r.getPenaltyN1(t)+r.getPenaltyN2(t)+r.getPenaltyN3(t)+r.getPenaltyN4(t);r.applyMask(d,t),f<c&&(c=f,s=d)}return s}})(fe)),fe}var W={},je;function gt(){if(je)return W;je=1;const r=Ie(),o=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],i=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];return W.getBlocksCount=function(t,n){switch(n){case r.L:return o[(t-1)*4+0];case r.M:return o[(t-1)*4+1];case r.Q:return o[(t-1)*4+2];case r.H:return o[(t-1)*4+3];default:return}},W.getTotalCodewordsCount=function(t,n){switch(n){case r.L:return i[(t-1)*4+0];case r.M:return i[(t-1)*4+1];case r.Q:return i[(t-1)*4+2];case r.H:return i[(t-1)*4+3];default:return}},W}var ge={},K={},Ke;function Bt(){if(Ke)return K;Ke=1;const r=new Uint8Array(512),o=new Uint8Array(256);return(function(){let e=1;for(let t=0;t<255;t++)r[t]=e,o[e]=t,e<<=1,e&256&&(e^=285);for(let t=255;t<512;t++)r[t]=r[t-255]})(),K.log=function(e){if(e<1)throw new Error("log("+e+")");return o[e]},K.exp=function(e){return r[e]},K.mul=function(e,t){return e===0||t===0?0:r[o[e]+o[t]]},K}var Ve;function Mt(){return Ve||(Ve=1,(function(r){const o=Bt();r.mul=function(e,t){const n=new Uint8Array(e.length+t.length-1);for(let a=0;a<e.length;a++)for(let s=0;s<t.length;s++)n[a+s]^=o.mul(e[a],t[s]);return n},r.mod=function(e,t){let n=new Uint8Array(e);for(;n.length-t.length>=0;){const a=n[0];for(let c=0;c<t.length;c++)n[c]^=o.mul(t[c],a);let s=0;for(;s<n.length&&n[s]===0;)s++;n=n.slice(s)}return n},r.generateECPolynomial=function(e){let t=new Uint8Array([1]);for(let n=0;n<e;n++)t=r.mul(t,new Uint8Array([1,o.exp(n)]));return t}})(ge)),ge}var me,Ye;function It(){if(Ye)return me;Ye=1;const r=Mt();function o(i){this.genPoly=void 0,this.degree=i,this.degree&&this.initialize(this.degree)}return o.prototype.initialize=function(e){this.degree=e,this.genPoly=r.generateECPolynomial(this.degree)},o.prototype.encode=function(e){if(!this.genPoly)throw new Error("Encoder not initialized");const t=new Uint8Array(e.length+this.degree);t.set(e);const n=r.mod(t,this.genPoly),a=this.degree-n.length;if(a>0){const s=new Uint8Array(this.degree);return s.set(n,a),s}return n},me=o,me}var he={},pe={},ye={},Qe;function mt(){return Qe||(Qe=1,ye.isValid=function(o){return!isNaN(o)&&o>=1&&o<=40}),ye}var U={},Ge;function ht(){if(Ge)return U;Ge=1;const r="[0-9]+",o="[A-Z $%*+\\-./:]+";let i="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";i=i.replace(/u/g,"\\u");const e="(?:(?![A-Z0-9 $%*+\\-./:]|"+i+`)(?:.|[\r
]))+`;U.KANJI=new RegExp(i,"g"),U.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),U.BYTE=new RegExp(e,"g"),U.NUMERIC=new RegExp(r,"g"),U.ALPHANUMERIC=new RegExp(o,"g");const t=new RegExp("^"+i+"$"),n=new RegExp("^"+r+"$"),a=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");return U.testKanji=function(c){return t.test(c)},U.testNumeric=function(c){return n.test(c)},U.testAlphanumeric=function(c){return a.test(c)},U}var We;function H(){return We||(We=1,(function(r){const o=mt(),i=ht();r.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},r.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},r.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},r.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},r.MIXED={bit:-1},r.getCharCountIndicator=function(n,a){if(!n.ccBits)throw new Error("Invalid mode: "+n);if(!o.isValid(a))throw new Error("Invalid version: "+a);return a>=1&&a<10?n.ccBits[0]:a<27?n.ccBits[1]:n.ccBits[2]},r.getBestModeForData=function(n){return i.testNumeric(n)?r.NUMERIC:i.testAlphanumeric(n)?r.ALPHANUMERIC:i.testKanji(n)?r.KANJI:r.BYTE},r.toString=function(n){if(n&&n.id)return n.id;throw new Error("Invalid mode")},r.isValid=function(n){return n&&n.bit&&n.ccBits};function e(t){if(typeof t!="string")throw new Error("Param is not a string");switch(t.toLowerCase()){case"numeric":return r.NUMERIC;case"alphanumeric":return r.ALPHANUMERIC;case"kanji":return r.KANJI;case"byte":return r.BYTE;default:throw new Error("Unknown mode: "+t)}}r.from=function(n,a){if(r.isValid(n))return n;try{return e(n)}catch{return a}}})(pe)),pe}var Ze;function xt(){return Ze||(Ze=1,(function(r){const o=_(),i=gt(),e=Ie(),t=H(),n=mt(),a=7973,s=o.getBCHDigit(a);function c(m,g,N){for(let B=1;B<=40;B++)if(g<=r.getCapacity(B,N,m))return B}function d(m,g){return t.getCharCountIndicator(m,g)+4}function f(m,g){let N=0;return m.forEach(function(B){const x=d(B.mode,g);N+=x+B.getBitsLength()}),N}function p(m,g){for(let N=1;N<=40;N++)if(f(m,N)<=r.getCapacity(N,g,t.MIXED))return N}r.from=function(g,N){return n.isValid(g)?parseInt(g,10):N},r.getCapacity=function(g,N,B){if(!n.isValid(g))throw new Error("Invalid QR Code version");typeof B>"u"&&(B=t.BYTE);const x=o.getSymbolTotalCodewords(g),A=i.getTotalCodewordsCount(g,N),M=(x-A)*8;if(B===t.MIXED)return M;const T=M-d(B,g);switch(B){case t.NUMERIC:return Math.floor(T/10*3);case t.ALPHANUMERIC:return Math.floor(T/11*2);case t.KANJI:return Math.floor(T/13);case t.BYTE:default:return Math.floor(T/8)}},r.getBestVersionForData=function(g,N){let B;const x=e.from(N,e.M);if(Array.isArray(g)){if(g.length>1)return p(g,x);if(g.length===0)return 1;B=g[0]}else B=g;return c(B.mode,B.getLength(),x)},r.getEncodedBits=function(g){if(!n.isValid(g)||g<7)throw new Error("Invalid QR Code version");let N=g<<12;for(;o.getBCHDigit(N)-s>=0;)N^=a<<o.getBCHDigit(N)-s;return g<<12|N}})(he)),he}var we={},Xe;function Rt(){if(Xe)return we;Xe=1;const r=_(),o=1335,i=21522,e=r.getBCHDigit(o);return we.getEncodedBits=function(n,a){const s=n.bit<<3|a;let c=s<<10;for(;r.getBCHDigit(c)-e>=0;)c^=o<<r.getBCHDigit(c)-e;return(s<<10|c)^i},we}var be={},ve,et;function Dt(){if(et)return ve;et=1;const r=H();function o(i){this.mode=r.NUMERIC,this.data=i.toString()}return o.getBitsLength=function(e){return 10*Math.floor(e/3)+(e%3?e%3*3+1:0)},o.prototype.getLength=function(){return this.data.length},o.prototype.getBitsLength=function(){return o.getBitsLength(this.data.length)},o.prototype.write=function(e){let t,n,a;for(t=0;t+3<=this.data.length;t+=3)n=this.data.substr(t,3),a=parseInt(n,10),e.put(a,10);const s=this.data.length-t;s>0&&(n=this.data.substr(t),a=parseInt(n,10),e.put(a,s*3+1))},ve=o,ve}var Ce,tt;function Ut(){if(tt)return Ce;tt=1;const r=H(),o=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function i(e){this.mode=r.ALPHANUMERIC,this.data=e}return i.getBitsLength=function(t){return 11*Math.floor(t/2)+6*(t%2)},i.prototype.getLength=function(){return this.data.length},i.prototype.getBitsLength=function(){return i.getBitsLength(this.data.length)},i.prototype.write=function(t){let n;for(n=0;n+2<=this.data.length;n+=2){let a=o.indexOf(this.data[n])*45;a+=o.indexOf(this.data[n+1]),t.put(a,11)}this.data.length%2&&t.put(o.indexOf(this.data[n]),6)},Ce=i,Ce}var Ee,nt;function $t(){if(nt)return Ee;nt=1;const r=H();function o(i){this.mode=r.BYTE,typeof i=="string"?this.data=new TextEncoder().encode(i):this.data=new Uint8Array(i)}return o.getBitsLength=function(e){return e*8},o.prototype.getLength=function(){return this.data.length},o.prototype.getBitsLength=function(){return o.getBitsLength(this.data.length)},o.prototype.write=function(i){for(let e=0,t=this.data.length;e<t;e++)i.put(this.data[e],8)},Ee=o,Ee}var Se,rt;function qt(){if(rt)return Se;rt=1;const r=H(),o=_();function i(e){this.mode=r.KANJI,this.data=e}return i.getBitsLength=function(t){return t*13},i.prototype.getLength=function(){return this.data.length},i.prototype.getBitsLength=function(){return i.getBitsLength(this.data.length)},i.prototype.write=function(e){let t;for(t=0;t<this.data.length;t++){let n=o.toSJIS(this.data[t]);if(n>=33088&&n<=40956)n-=33088;else if(n>=57408&&n<=60351)n-=49472;else throw new Error("Invalid SJIS character: "+this.data[t]+`
Make sure your charset is UTF-8`);n=(n>>>8&255)*192+(n&255),e.put(n,13)}},Se=i,Se}var Pe={exports:{}},ot;function Ft(){return ot||(ot=1,(function(r){var o={single_source_shortest_paths:function(i,e,t){var n={},a={};a[e]=0;var s=o.PriorityQueue.make();s.push(e,0);for(var c,d,f,p,m,g,N,B,x;!s.empty();){c=s.pop(),d=c.value,p=c.cost,m=i[d]||{};for(f in m)m.hasOwnProperty(f)&&(g=m[f],N=p+g,B=a[f],x=typeof a[f]>"u",(x||B>N)&&(a[f]=N,s.push(f,N),n[f]=d))}if(typeof t<"u"&&typeof a[t]>"u"){var A=["Could not find a path from ",e," to ",t,"."].join("");throw new Error(A)}return n},extract_shortest_path_from_predecessor_list:function(i,e){for(var t=[],n=e;n;)t.push(n),i[n],n=i[n];return t.reverse(),t},find_path:function(i,e,t){var n=o.single_source_shortest_paths(i,e,t);return o.extract_shortest_path_from_predecessor_list(n,t)},PriorityQueue:{make:function(i){var e=o.PriorityQueue,t={},n;i=i||{};for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.queue=[],t.sorter=i.sorter||e.default_sorter,t},default_sorter:function(i,e){return i.cost-e.cost},push:function(i,e){var t={value:i,cost:e};this.queue.push(t),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};r.exports=o})(Pe)),Pe.exports}var it;function Ot(){return it||(it=1,(function(r){const o=H(),i=Dt(),e=Ut(),t=$t(),n=qt(),a=ht(),s=_(),c=Ft();function d(A){return unescape(encodeURIComponent(A)).length}function f(A,M,T){const P=[];let R;for(;(R=A.exec(T))!==null;)P.push({data:R[0],index:R.index,mode:M,length:R[0].length});return P}function p(A){const M=f(a.NUMERIC,o.NUMERIC,A),T=f(a.ALPHANUMERIC,o.ALPHANUMERIC,A);let P,R;return s.isKanjiModeEnabled()?(P=f(a.BYTE,o.BYTE,A),R=f(a.KANJI,o.KANJI,A)):(P=f(a.BYTE_KANJI,o.BYTE,A),R=[]),M.concat(T,P,R).sort(function(C,v){return C.index-v.index}).map(function(C){return{data:C.data,mode:C.mode,length:C.length}})}function m(A,M){switch(M){case o.NUMERIC:return i.getBitsLength(A);case o.ALPHANUMERIC:return e.getBitsLength(A);case o.KANJI:return n.getBitsLength(A);case o.BYTE:return t.getBitsLength(A)}}function g(A){return A.reduce(function(M,T){const P=M.length-1>=0?M[M.length-1]:null;return P&&P.mode===T.mode?(M[M.length-1].data+=T.data,M):(M.push(T),M)},[])}function N(A){const M=[];for(let T=0;T<A.length;T++){const P=A[T];switch(P.mode){case o.NUMERIC:M.push([P,{data:P.data,mode:o.ALPHANUMERIC,length:P.length},{data:P.data,mode:o.BYTE,length:P.length}]);break;case o.ALPHANUMERIC:M.push([P,{data:P.data,mode:o.BYTE,length:P.length}]);break;case o.KANJI:M.push([P,{data:P.data,mode:o.BYTE,length:d(P.data)}]);break;case o.BYTE:M.push([{data:P.data,mode:o.BYTE,length:d(P.data)}])}}return M}function B(A,M){const T={},P={start:{}};let R=["start"];for(let y=0;y<A.length;y++){const C=A[y],v=[];for(let h=0;h<C.length;h++){const k=C[h],w=""+y+h;v.push(w),T[w]={node:k,lastCount:0},P[w]={};for(let E=0;E<R.length;E++){const b=R[E];T[b]&&T[b].node.mode===k.mode?(P[b][w]=m(T[b].lastCount+k.length,k.mode)-m(T[b].lastCount,k.mode),T[b].lastCount+=k.length):(T[b]&&(T[b].lastCount=k.length),P[b][w]=m(k.length,k.mode)+4+o.getCharCountIndicator(k.mode,M))}}R=v}for(let y=0;y<R.length;y++)P[R[y]].end=0;return{map:P,table:T}}function x(A,M){let T;const P=o.getBestModeForData(A);if(T=o.from(M,P),T!==o.BYTE&&T.bit<P.bit)throw new Error('"'+A+'" cannot be encoded with mode '+o.toString(T)+`.
 Suggested mode is: `+o.toString(P));switch(T===o.KANJI&&!s.isKanjiModeEnabled()&&(T=o.BYTE),T){case o.NUMERIC:return new i(A);case o.ALPHANUMERIC:return new e(A);case o.KANJI:return new n(A);case o.BYTE:return new t(A)}}r.fromArray=function(M){return M.reduce(function(T,P){return typeof P=="string"?T.push(x(P,null)):P.data&&T.push(x(P.data,P.mode)),T},[])},r.fromString=function(M,T){const P=p(M,s.isKanjiModeEnabled()),R=N(P),y=B(R,T),C=c.find_path(y.map,"start","end"),v=[];for(let h=1;h<C.length-1;h++)v.push(y.table[C[h]].node);return r.fromArray(g(v))},r.rawSplit=function(M){return r.fromArray(p(M,s.isKanjiModeEnabled()))}})(be)),be}var at;function _t(){if(at)return ae;at=1;const r=_(),o=Ie(),i=kt(),e=At(),t=Tt(),n=Nt(),a=Lt(),s=gt(),c=It(),d=xt(),f=Rt(),p=H(),m=Ot();function g(y,C){const v=y.size,h=n.getPositions(C);for(let k=0;k<h.length;k++){const w=h[k][0],E=h[k][1];for(let b=-1;b<=7;b++)if(!(w+b<=-1||v<=w+b))for(let L=-1;L<=7;L++)E+L<=-1||v<=E+L||(b>=0&&b<=6&&(L===0||L===6)||L>=0&&L<=6&&(b===0||b===6)||b>=2&&b<=4&&L>=2&&L<=4?y.set(w+b,E+L,!0,!0):y.set(w+b,E+L,!1,!0))}}function N(y){const C=y.size;for(let v=8;v<C-8;v++){const h=v%2===0;y.set(v,6,h,!0),y.set(6,v,h,!0)}}function B(y,C){const v=t.getPositions(C);for(let h=0;h<v.length;h++){const k=v[h][0],w=v[h][1];for(let E=-2;E<=2;E++)for(let b=-2;b<=2;b++)E===-2||E===2||b===-2||b===2||E===0&&b===0?y.set(k+E,w+b,!0,!0):y.set(k+E,w+b,!1,!0)}}function x(y,C){const v=y.size,h=d.getEncodedBits(C);let k,w,E;for(let b=0;b<18;b++)k=Math.floor(b/3),w=b%3+v-8-3,E=(h>>b&1)===1,y.set(k,w,E,!0),y.set(w,k,E,!0)}function A(y,C,v){const h=y.size,k=f.getEncodedBits(C,v);let w,E;for(w=0;w<15;w++)E=(k>>w&1)===1,w<6?y.set(w,8,E,!0):w<8?y.set(w+1,8,E,!0):y.set(h-15+w,8,E,!0),w<8?y.set(8,h-w-1,E,!0):w<9?y.set(8,15-w-1+1,E,!0):y.set(8,15-w-1,E,!0);y.set(h-8,8,1,!0)}function M(y,C){const v=y.size;let h=-1,k=v-1,w=7,E=0;for(let b=v-1;b>0;b-=2)for(b===6&&b--;;){for(let L=0;L<2;L++)if(!y.isReserved(k,b-L)){let F=!1;E<C.length&&(F=(C[E]>>>w&1)===1),y.set(k,b-L,F),w--,w===-1&&(E++,w=7)}if(k+=h,k<0||v<=k){k-=h,h=-h;break}}}function T(y,C,v){const h=new i;v.forEach(function(L){h.put(L.mode.bit,4),h.put(L.getLength(),p.getCharCountIndicator(L.mode,y)),L.write(h)});const k=r.getSymbolTotalCodewords(y),w=s.getTotalCodewordsCount(y,C),E=(k-w)*8;for(h.getLengthInBits()+4<=E&&h.put(0,4);h.getLengthInBits()%8!==0;)h.putBit(0);const b=(E-h.getLengthInBits())/8;for(let L=0;L<b;L++)h.put(L%2?17:236,8);return P(h,y,C)}function P(y,C,v){const h=r.getSymbolTotalCodewords(C),k=s.getTotalCodewordsCount(C,v),w=h-k,E=s.getBlocksCount(C,v),b=h%E,L=E-b,F=Math.floor(h/E),j=Math.floor(w/E),vt=j+1,Re=F-j,Ct=new c(Re);let te=0;const G=new Array(E),De=new Array(E);let ne=0;const Et=new Uint8Array(y.buffer);for(let J=0;J<E;J++){const oe=J<L?j:vt;G[J]=Et.slice(te,te+oe),De[J]=Ct.encode(G[J]),te+=oe,ne=Math.max(ne,oe)}const re=new Uint8Array(h);let Ue=0,$,q;for($=0;$<ne;$++)for(q=0;q<E;q++)$<G[q].length&&(re[Ue++]=G[q][$]);for($=0;$<Re;$++)for(q=0;q<E;q++)re[Ue++]=De[q][$];return re}function R(y,C,v,h){let k;if(Array.isArray(y))k=m.fromArray(y);else if(typeof y=="string"){let F=C;if(!F){const j=m.rawSplit(y);F=d.getBestVersionForData(j,v)}k=m.fromString(y,F||40)}else throw new Error("Invalid data");const w=d.getBestVersionForData(k,v);if(!w)throw new Error("The amount of data is too big to be stored in a QR Code");if(!C)C=w;else if(C<w)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+w+`.
`);const E=T(C,v,k),b=r.getSymbolSize(C),L=new e(b);return g(L,C),N(L),B(L,C),A(L,v,0),C>=7&&x(L,C),M(L,E),isNaN(h)&&(h=a.getBestMask(L,A.bind(null,L,v))),a.applyMask(h,L),A(L,v,h),{modules:L,version:C,errorCorrectionLevel:v,maskPattern:h,segments:k}}return ae.create=function(C,v){if(typeof C>"u"||C==="")throw new Error("No input text");let h=o.M,k,w;return typeof v<"u"&&(h=o.from(v.errorCorrectionLevel,o.M),k=d.from(v.version),w=a.from(v.maskPattern),v.toSJISFunc&&r.setToSJISFunction(v.toSJISFunc)),R(C,k,h,w)},ae}var ke={},Ae={},st;function pt(){return st||(st=1,(function(r){function o(i){if(typeof i=="number"&&(i=i.toString()),typeof i!="string")throw new Error("Color should be defined as hex string");let e=i.slice().replace("#","").split("");if(e.length<3||e.length===5||e.length>8)throw new Error("Invalid hex color: "+i);(e.length===3||e.length===4)&&(e=Array.prototype.concat.apply([],e.map(function(n){return[n,n]}))),e.length===6&&e.push("F","F");const t=parseInt(e.join(""),16);return{r:t>>24&255,g:t>>16&255,b:t>>8&255,a:t&255,hex:"#"+e.slice(0,6).join("")}}r.getOptions=function(e){e||(e={}),e.color||(e.color={});const t=typeof e.margin>"u"||e.margin===null||e.margin<0?4:e.margin,n=e.width&&e.width>=21?e.width:void 0,a=e.scale||4;return{width:n,scale:n?4:a,margin:t,color:{dark:o(e.color.dark||"#000000ff"),light:o(e.color.light||"#ffffffff")},type:e.type,rendererOpts:e.rendererOpts||{}}},r.getScale=function(e,t){return t.width&&t.width>=e+t.margin*2?t.width/(e+t.margin*2):t.scale},r.getImageWidth=function(e,t){const n=r.getScale(e,t);return Math.floor((e+t.margin*2)*n)},r.qrToImageData=function(e,t,n){const a=t.modules.size,s=t.modules.data,c=r.getScale(a,n),d=Math.floor((a+n.margin*2)*c),f=n.margin*c,p=[n.color.light,n.color.dark];for(let m=0;m<d;m++)for(let g=0;g<d;g++){let N=(m*d+g)*4,B=n.color.light;if(m>=f&&g>=f&&m<d-f&&g<d-f){const x=Math.floor((m-f)/c),A=Math.floor((g-f)/c);B=p[s[x*a+A]?1:0]}e[N++]=B.r,e[N++]=B.g,e[N++]=B.b,e[N]=B.a}}})(Ae)),Ae}var ct;function Ht(){return ct||(ct=1,(function(r){const o=pt();function i(t,n,a){t.clearRect(0,0,n.width,n.height),n.style||(n.style={}),n.height=a,n.width=a,n.style.height=a+"px",n.style.width=a+"px"}function e(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}r.render=function(n,a,s){let c=s,d=a;typeof c>"u"&&(!a||!a.getContext)&&(c=a,a=void 0),a||(d=e()),c=o.getOptions(c);const f=o.getImageWidth(n.modules.size,c),p=d.getContext("2d"),m=p.createImageData(f,f);return o.qrToImageData(m.data,n,c),i(p,d,f),p.putImageData(m,0,0),d},r.renderToDataURL=function(n,a,s){let c=s;typeof c>"u"&&(!a||!a.getContext)&&(c=a,a=void 0),c||(c={});const d=r.render(n,a,c),f=c.type||"image/png",p=c.rendererOpts||{};return d.toDataURL(f,p.quality)}})(ke)),ke}var Te={},lt;function Jt(){if(lt)return Te;lt=1;const r=pt();function o(t,n){const a=t.a/255,s=n+'="'+t.hex+'"';return a<1?s+" "+n+'-opacity="'+a.toFixed(2).slice(1)+'"':s}function i(t,n,a){let s=t+n;return typeof a<"u"&&(s+=" "+a),s}function e(t,n,a){let s="",c=0,d=!1,f=0;for(let p=0;p<t.length;p++){const m=Math.floor(p%n),g=Math.floor(p/n);!m&&!d&&(d=!0),t[p]?(f++,p>0&&m>0&&t[p-1]||(s+=d?i("M",m+a,.5+g+a):i("m",c,0),c=0,d=!1),m+1<n&&t[p+1]||(s+=i("h",f),f=0)):c++}return s}return Te.render=function(n,a,s){const c=r.getOptions(a),d=n.modules.size,f=n.modules.data,p=d+c.margin*2,m=c.color.light.a?"<path "+o(c.color.light,"fill")+' d="M0 0h'+p+"v"+p+'H0z"/>':"",g="<path "+o(c.color.dark,"stroke")+' d="'+e(f,d,c.margin)+'"/>',N='viewBox="0 0 '+p+" "+p+'"',x='<svg xmlns="http://www.w3.org/2000/svg" '+(c.width?'width="'+c.width+'" height="'+c.width+'" ':"")+N+' shape-rendering="crispEdges">'+m+g+`</svg>
`;return typeof s=="function"&&s(null,x),x},Te}var dt;function zt(){if(dt)return z;dt=1;const r=Pt(),o=_t(),i=Ht(),e=Jt();function t(n,a,s,c,d){const f=[].slice.call(arguments,1),p=f.length,m=typeof f[p-1]=="function";if(!m&&!r())throw new Error("Callback required as last argument");if(m){if(p<2)throw new Error("Too few arguments provided");p===2?(d=s,s=a,a=c=void 0):p===3&&(a.getContext&&typeof d>"u"?(d=c,c=void 0):(d=c,c=s,s=a,a=void 0))}else{if(p<1)throw new Error("Too few arguments provided");return p===1?(s=a,a=c=void 0):p===2&&!a.getContext&&(c=s,s=a,a=void 0),new Promise(function(g,N){try{const B=o.create(s,c);g(n(B,a,c))}catch(B){N(B)}})}try{const g=o.create(s,c);d(null,n(g,a,c))}catch(g){d(g)}}return z.create=o.create,z.toCanvas=t.bind(null,i.render),z.toDataURL=t.bind(null,i.renderToDataURL),z.toString=t.bind(null,function(n,a,s){return e.render(n,s)}),z}var jt=zt();const Kt=St(jt),u={token:null,me:null,sabPage:1,sabPages:1,sabTimer:null,npTimer:null,apps:[],resetToken:null},l=r=>document.querySelector(r);function Q(){try{history.replaceState&&history.replaceState(null,"",location.pathname)}catch{}}function S(r,o="ok"){const i=l("#toasts"),e=document.createElement("div");e.className=`toast ${o==="ok"?"toast-ok":"toast-err"}`,e.textContent=r,i.appendChild(e),setTimeout(()=>e.remove(),3500)}function yt(){const r=u.me&&u.me.preferences&&u.me.preferences.theme||"dark";document.body.setAttribute("data-theme",r)}const Vt={open({title:r,bodyHTML:o,confirmText:i="Confirm",onConfirm:e,onOpen:t}){l("#modalTitle").textContent=r||"",l("#modalBody").innerHTML=o||"",l("#modalOk").textContent=i,l("#modal").classList.remove("hidden"),t&&t();const n=l("#modalOk"),a=l("#modalCancel"),s=()=>l("#modal").classList.add("hidden");a.onclick=s,n.onclick=async()=>{try{await e?.()}finally{s()}}}};function D(r){for(const i of["#view-login","#view-register","#view-forgot","#view-reset","#view-apps","#view-admin","#view-settings"]){const e=l(i);e&&e.classList.add("hidden")}const o=l(r);o&&o.classList.remove("hidden"),window.scrollTo({top:0,behavior:"smooth"})}const Yt=new URLSearchParams(location.search),ut=Yt.get("token");ut&&(u.resetToken=ut,D("#view-reset"));function X(r){if(r==null||!isFinite(r))return"0:00";r=Math.max(0,Math.floor(r));const o=Math.floor(r/3600),i=Math.floor(r%3600/60),e=r%60;return(o?`${o}:${String(i).padStart(2,"0")}`:`${i}`)+`:${String(e).padStart(2,"0")}`}async function I(r,o={}){const i=await fetch(r,Object.assign({headers:{"Content-Type":"application/json",...u.token?{Authorization:"Bearer "+u.token}:{}}},o)),e=i.headers.get("content-type")||"",t=await i.text();let n;if(e.includes("application/json"))try{n=JSON.parse(t)}catch{throw{error:"Invalid JSON from server",raw:t}}else throw{error:`Bad response (${i.status})`,body:t.slice(0,200)};if(!i.ok)throw n;return n}l("#brandLink").onclick=r=>{r.preventDefault(),u.token?D("#view-apps"):D("#view-login")};document.addEventListener("click",r=>{const o=r.target.closest(".tab");if(!o)return;document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),o.classList.add("active");const i=o.dataset.tab;["apps","users","invites"].forEach(e=>l("#tab-"+e)?.classList.toggle("hidden",e!==i))});function wt(r,o){const i=l(r);if(!i)return;i.innerHTML="";const e=document.createElement("canvas");e.width=240,e.height=240,i.appendChild(e),Kt.toCanvas(e,o,{width:240,margin:1,color:{dark:"#000",light:"#fff"}},t=>{t&&console.error(t)})}async function Y(r){try{await navigator.clipboard.writeText(r)}catch{const o=document.createElement("textarea");o.value=r,document.body.appendChild(o),o.select(),document.execCommand("copy"),o.remove()}S("Copied to clipboard")}(function(){const r=localStorage.getItem("zm_token");r&&(u.token=r,I("/api/me").then(o=>{u.me=o.user,Q(),xe(!1)}).catch(()=>{localStorage.removeItem("zm_token"),u.token=null}))})();document.getElementById("loginForm").addEventListener("submit",async r=>{r.preventDefault();const o=l("#loginError");o&&(o.textContent="");const i=new FormData(r.target),e=!!i.get("remember"),t={username:i.get("username"),password:i.get("password"),remember:e},n=i.get("otp");n&&(t.otp=n);try{const{token:a,user:s}=await I("/api/login",{method:"POST",body:JSON.stringify(t)});u.token=a,u.me=s,e?localStorage.setItem("zm_token",a):localStorage.removeItem("zm_token"),Q(),xe()}catch(a){if(a&&a.error==="MFA code required"){const s=l("#otpWrap");s&&(s.classList.remove("hidden"),s.querySelector('input[name="otp"]').focus());return}(o||{}).textContent=a&&(a.error||a.message)?a.error||a.message:"Login failed"}});l("#btn-register").onclick=r=>{r.preventDefault(),D("#view-register")};l("#btn-forgot").onclick=r=>{r.preventDefault(),D("#view-forgot")};document.getElementById("registerForm").addEventListener("submit",async r=>{r.preventDefault();const o=new FormData(r.target),i=(o.get("username")||"").trim(),e=o.get("password"),t=(o.get("email")||"").trim().toLowerCase(),n={inviteCode:o.get("inviteCode"),username:i,password:e,email:t,enableTotp:!!o.get("enableTotp")};try{const{otpauth:a,secret:s}=await I("/api/register",{method:"POST",body:JSON.stringify(n)});if(a){const c=s||(()=>{try{const p=new URL(a);return new URLSearchParams(p.search).get("secret")||""}catch{}return""})();r.target.classList.add("hidden"),l("#registerMfa").classList.remove("hidden"),l("#otpauth").textContent=a,l("#otpsecret").textContent=c,l("#copyOtpauth").onclick=()=>Y(a),l("#copySecret").onclick=()=>Y(c);try{wt("#qr",a)}catch(p){console.error(p)}const f=l("#registerOtp");l("#registerVerify").onclick=async()=>{const p=(f.value||"").trim();if(!/^[0-9]{6}$/.test(p))return S("Enter the 6‑digit code from your app","err");try{const{token:m,user:g}=await I("/api/login",{method:"POST",body:JSON.stringify({username:i,password:e,otp:p})});u.token=m,u.me=g,localStorage.setItem("zm_token",m),Q(),S("Account created!"),xe()}catch(m){S(m.error||"Invalid or expired MFA code","err")}}}else S("Account created! You can now sign in."),D("#view-login")}catch(a){S(a.error||"Registration failed","err")}});l("#btn-register-back").onclick=r=>{r.preventDefault(),D("#view-login")};document.getElementById("forgotForm").addEventListener("submit",async r=>{r.preventDefault();const i=(new FormData(r.target).get("email")||"").trim().toLowerCase();try{await I("/api/forgot-password",{method:"POST",body:JSON.stringify({email:i})}),S("If the email exists, a reset link has been sent."),D("#view-login")}catch(e){S(e.error||"Request failed","err")}});l("#btn-forgot-back").onclick=r=>{r.preventDefault(),D("#view-login")};document.getElementById("resetForm").addEventListener("submit",async r=>{r.preventDefault();const o=new FormData(r.target);try{await I("/api/reset",{method:"POST",body:JSON.stringify({token:u.resetToken,newPassword:o.get("password")})}),S("Password updated. Sign in."),Q(),D("#view-login")}catch(i){S(i.error||"Reset failed","err")}});l("#btn-reset-back").onclick=r=>{r.preventDefault(),Q(),D("#view-login")};function bt(r){const o=(r.firstName||"").trim(),i=(r.lastName||"").trim(),e=(r.username||"").trim();return(o||i)&&((o[0]||"")+(i[0]||"")).toUpperCase()||(e[0]||"?").toUpperCase()}async function xe(r){const o=u.me||(await I("/api/me")).user;u.me=o,yt(),l("#navArea").classList.remove("hidden");const i=[u.me.firstName,u.me.lastName].filter(Boolean).join(" ")||u.me.username||"";l("#userName").textContent=i;const e=l("#userAvatar"),t=l("#userInitial");u.me.profileImage?(e.src=u.me.profileImage,e.classList.remove("hidden"),t.classList.add("hidden")):(t.textContent=bt(u.me),t.classList.remove("hidden"),e.classList.add("hidden")),u.me.role==="admin"&&l("#ddAdmin").classList.remove("hidden");const n=l("#userMenu"),a=l("#userBtn");a.onclick=d=>{d.preventDefault(),n.classList.toggle("open")},document.addEventListener("click",d=>{n.contains(d.target)||n.classList.remove("open")}),l("#ddSettings").onclick=()=>{nn(),D("#view-settings"),n.classList.remove("open")},l("#ddAdmin").onclick=()=>{D("#view-admin"),n.classList.remove("open")},l("#ddLogout").onclick=async()=>{await I("/api/logout",{method:"POST"}),localStorage.removeItem("zm_token"),location.reload()};const s=l("#prefNPRow"),c=l("#prefShowNP");if(u.me.role==="admin"){s.classList.remove("hidden");const d=u.me.preferences&&"showNowPlaying"in u.me.preferences?!!u.me.preferences.showNowPlaying:!0;c.checked=d}else s.classList.add("hidden");await Ne(),ee(),u.sabPage=1,Zt(),en(),Me(),r||D("#view-apps")}function Qt(r,o){if(!Array.isArray(o)||!o.length)return r.slice();const i=new Map(o.map((e,t)=>[e,t]));return r.slice().sort((e,t)=>{const n=i.has(e.key)?i.get(e.key):1/0,a=i.has(t.key)?i.get(t.key):1/0;return n!==a?n-a:(e.name||"").localeCompare(t.name||"")})}async function Gt(r){try{await I("/api/me",{method:"PUT",body:JSON.stringify({appOrder:r})}),u.me.preferences=u.me.preferences||{},u.me.preferences.appOrder=r.slice(),S("App order saved")}catch(o){S(o.error||"Failed to save order","err")}}async function Ne(){const{apps:r}=await I("/api/apps"),o=u.me.role==="admin"?r:r.filter(e=>!e.hidden&&!e._hidden),i=u.me.preferences&&Array.isArray(u.me.preferences.appOrder)?u.me.preferences.appOrder:[];if(u.apps=Qt(o,i),u.me.role==="admin"){const e=l("#appsEditor");if(e){const t=n=>{e.className="apps-grid",e.innerHTML="";for(const a of n){const s=document.createElement("div");s.className="app-card rounded-xl bg-white/5 border border-white/10 p-3",s.innerHTML=`
                <div class="flex items-center justify-between gap-3">
                  <div class="flex items-center gap-3 min-w-0">
                    <img id="logoPreview-${a.key}" src="${a.logo||""}" onerror="this.src='';this.classList.add('opacity-40');" class="h-10 w-10 object-contain rounded bg-white/10 p-1" alt="logo" />
                    <div class="min-w-0">
                      <div class="text-base font-semibold truncate">${a.name||"(unnamed app)"}</div>
                      <div class="text-xs text-neutral-300 truncate">${a.url||""}</div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 shrink-0">
                    <label class="text-xs flex items-center gap-2 select-none">
                      <input data-k="hidden" data-key="${a.key}" type="checkbox" ${a.hidden?"checked":""}/>
                      <span>Hide</span>
                    </label>
                    <button class="px-2 py-1 bg-red-700/80 rounded text-xs" data-del="${a.key}">Delete</button>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                  <div>
                    <label class="block text-xs mb-1">Name</label>
                    <input data-k="name" data-key="${a.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${a.name||""}">
                  </div>
                  <div>
                    <label class="block text-xs mb-1">App URL</label>
                    <input data-k="url" data-key="${a.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${a.url||""}">
                  </div>
                  <div>
                    <label class="block text-xs mb-1">Logo URL</label>
                    <input data-k="logo" data-key="${a.key}" class="w-full px-2 py-1 rounded bg-black/30 border border-white/10" value="${a.logo||""}">
                  </div>
                </div>`,e.appendChild(s)}e.querySelectorAll('input[data-k="logo"]').forEach(a=>{a.addEventListener("input",s=>{const c=s.target.getAttribute("data-key"),d=document.getElementById("logoPreview-"+c);d&&(d.src=s.target.value.trim())})}),e.querySelectorAll("button[data-del]").forEach(a=>{a.onclick=()=>{const s=a.getAttribute("data-del"),d=e.querySelector(`input[data-k="name"][data-key="${s}"]`)?.value?.trim()||"";Vt.open({title:"Delete App",bodyHTML:'Are you sure you want to delete "<span id="delAppName"></span>"?',confirmText:"Delete",onOpen:()=>{l("#delAppName").textContent=d},onConfirm:async()=>{try{await I("/api/apps/"+encodeURIComponent(s),{method:"DELETE"}),S("App deleted"),await Ne(),ee()}catch(f){S(f.error||"Delete failed","err")}}})}})};t(r),l("#addApp").onclick=()=>{const n={key:Wt(),name:"",url:"",logo:"",hidden:!1};r.push(n),t(r),S('New app row added. Fill fields and click "Save Apps".')},l("#saveApps").onclick=async()=>{const n=r.map(a=>({...a}));document.querySelectorAll("#appsEditor [data-k]").forEach(a=>{const s=a.getAttribute("data-k"),c=a.getAttribute("data-key"),d=n.find(f=>f.key===c);d&&(s==="hidden"?d.hidden=a.checked:d[s]=a.value.trim())});for(const a of n)if(!a.name||!a.url){S("Each app needs at least a Name and URL","err");return}await I("/api/apps",{method:"PUT",body:JSON.stringify({apps:n})}),S("Apps saved"),await Ne(),ee()}}try{const t=await I("/api/sab");l("#sabBaseUrl").value=t.sab.baseUrl||"",l("#sabApiKey").value=t.sab.apiKey||"";const n=l("#saveSab");n&&(n.onclick=async()=>{await I("/api/sab",{method:"PUT",body:JSON.stringify({baseUrl:l("#sabBaseUrl").value.trim(),apiKey:l("#sabApiKey").value.trim()})}),S("SAB settings saved"),l("#testSab")?.click()});const a=l("#testSab");a&&(a.onclick=async()=>{try{const s=await I("/api/sab/test");s.ok?S("SAB connection successful"):S(`SAB test failed (status ${s.status})`,"err")}catch(s){S(s.error||"SAB test failed","err")}})}catch{}try{const t=await I("/api/plex");if(t&&t.plex){const s=l("#plexToken"),c=l("#plexBaseUrl");s&&(s.value=t.plex.token||""),c&&(c.value=t.plex.baseUrl||"")}const n=l("#savePlex");n&&(n.onclick=async()=>{const s=(l("#plexToken")?.value||"").trim();let c=(l("#plexBaseUrl")?.value||"").trim();await I("/api/plex",{method:"PUT",body:JSON.stringify({baseUrl:c,token:s})}),S("Plex settings saved"),l("#testPlex")?.click()});const a=l("#testPlex");a&&(a.onclick=async()=>{try{const s=await I("/api/plex/test");s.ok?S("Plex connection successful"):S(`Plex test failed (status ${s.status})`,"err")}catch(s){S(s.error||"Plex test failed","err")}})}catch{}try{const t=await I("/api/smtp");l("#smtpHost").value=t.smtp.host||"",l("#smtpPort").value=t.smtp.port||"",l("#smtpUser").value=t.smtp.user||"",l("#smtpFrom").value=t.smtp.from||"",l("#smtpSecure").checked=t.smtp.secure||!1;const n=l("#saveSmtp");n&&(n.onclick=async()=>{await I("/api/smtp",{method:"PUT",body:JSON.stringify({host:l("#smtpHost").value.trim(),port:Number(l("#smtpPort").value.trim()||"587"),user:l("#smtpUser").value.trim(),pass:l("#smtpPass").value,from:l("#smtpFrom").value.trim(),secure:l("#smtpSecure").checked})}),S("SMTP settings saved")});const a=l("#testSmtp");a&&(a.onclick=async()=>{try{(await I("/api/smtp/test")).ok?S("Test email sent"):S("SMTP test failed","err")}catch(s){S(s.error||"SMTP test failed","err")}})}catch{}await Le(),await V()}}function Wt(){return Math.random().toString(16).slice(2,10)}async function Le(){const r=l("#usersList");if(!r)return;const o=await I("/api/users"),i=o.users.filter(e=>e.role==="admin").length;r.innerHTML="";for(const e of o.users){const t=document.createElement("div");t.className="bg-white/5 border border-white/10 rounded p-3";const n=((e.firstName||"")[0]||"")+((e.lastName||"")[0]||""),a=e.profileImage?`<img src="${e.profileImage}" class="h-8 w-8 rounded-full object-cover mr-2" alt="avatar" />`:`<span class="mr-2 inline-flex items-center justify-center h-8 w-8 rounded-full text-sm font-semibold" style="background:linear-gradient(135deg, rgba(253,81,58,.9), rgba(44,83,216,.85));">${(n||e.username||"?").slice(0,2).toUpperCase()}</span>`,s=[e.firstName,e.lastName].filter(Boolean).join(" ")||e.username;t.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="text-sm flex items-center">
              ${a}
              <span class="font-semibold truncate max-w-[40vw]">${s}</span>
              <span class="text-neutral-300 ml-2">(${e.role})</span>
            </div>
            <div class="flex gap-2">
              <button type="button" data-act="promote" class="px-2 py-1 bg-white/10 rounded">Toggle Admin</button>
              <button type="button" data-act="delete" class="px-2 py-1 bg-red-700/80 rounded">Delete</button>
            </div>
          </div>`;const c=t.querySelector('[data-act="promote"]');c.disabled=i<=1&&e.role==="admin",c.classList.toggle("opacity-50",c.disabled),c.onclick=async()=>{const d=e.role==="admin"?"user":"admin";try{await I(`/api/users/${e.username}`,{method:"PATCH",body:JSON.stringify({role:d})}),S("Role updated"),await Le()}catch(f){S(f.error||"Update failed","err")}},t.querySelector('[data-act="delete"]').onclick=async()=>{if(confirm(`Delete user ${e.username}? This cannot be undone.`))try{await I(`/api/users/${encodeURIComponent(e.username)}`,{method:"DELETE"}),S("User deleted"),await Le()}catch(d){S(d.error||"Delete failed","err")}},r.appendChild(t)}}async function V(){const r=l("#invList");if(!r)return;const i=(await I("/api/invites")).invites.sort((e,t)=>(t.createdAt||"").localeCompare(e.createdAt||"")).map(e=>`<tr class="border-t border-white/10"><td class="py-2 pr-2 mono">${e.code}</td><td>${e.role}</td><td>${e.createdBy||""}</td><td>${e.createdAt||""}</td><td>${e.expiresAt||"never"}</td><td>${e.usedBy||""}</td><td>${e.usedAt||""}</td><td class="text-right"><button data-code="${e.code}" class="px-2 py-1 bg-white/10 rounded copy">Copy</button><button data-code="${e.code}" class="ml-2 px-2 py-1 bg-red-700/80 rounded del">Delete</button></td></tr>`).join("");r.innerHTML=`<table class="w-full text-sm"><thead class="text-neutral-300"><tr><th class="text-left py-2">Code</th><th class="text-left">Role</th><th class="text-left">Created by</th><th class="text-left">Created at</th><th class="text-left">Expires</th><th class="text-left">Used by</th><th class="text-left">Used at</th><th class="text-right">Actions</th></tr></thead><tbody>${i||'<tr><td class="py-2 text-neutral-300" colspan="8">No invites</td></tr>'}</tbody></table>`,r.querySelectorAll(".copy").forEach(e=>e.onclick=()=>Y(e.dataset.code)),r.querySelectorAll(".del").forEach(e=>e.onclick=async()=>{confirm(`Delete invite ${e.dataset.code}?`)&&(await I(`/api/invites/${e.dataset.code}`,{method:"DELETE"}),S("Invite deleted"),await V())}),l("#invCreate").onclick=async()=>{const e=l("#invRole").value||"user",t=(()=>{const s=l("#invPreset").value;if(s==="never")return null;const c=new Date;return s==="1d"&&c.setDate(c.getDate()+1),s==="7d"&&c.setDate(c.getDate()+7),s==="1m"&&c.setMonth(c.getMonth()+1),s==="6m"&&c.setMonth(c.getMonth()+6),c.toISOString()})(),n=(l("#invEmail")?.value||"").trim(),a=await I("/api/invites",{method:"POST",body:JSON.stringify({role:e,expiresAt:t,email:n||void 0})});S(`Invite created: ${a.code}${a.emailSent?" (email sent)":""}`),l("#invEmail")&&(l("#invEmail").value=""),await V()},l("#eraseUsedInvites").onclick=async()=>{confirm("Erase USED invites from history? This cannot be undone.")&&(await I("/api/invites/erase-history",{method:"POST",body:JSON.stringify({includeUnused:!1})}),S("Used invite history cleared"),await V())},l("#eraseAllInvites").onclick=async()=>{confirm("Erase ALL invites? This cannot be undone.")&&(await I("/api/invites/erase-history",{method:"POST",body:JSON.stringify({includeUnused:!0})}),S("All invites cleared"),await V())}}function ee(){const r=l("#tiles");if(r){r.innerHTML="";for(const o of u.apps){const i=document.createElement("a");i.href=o.url,i.target="_blank",i.className="tile glass rounded-2xl p-4 flex items-center gap-4 no-underline text-inherit",i.setAttribute("draggable","true"),i.dataset.key=o.key,i.innerHTML=`<img src="${o.logo}" class="h-10 w-10 object-contain" alt="${o.name}"><div><div class="font-semibold">${o.name}</div><div class="text-xs text-neutral-300">${o.url}</div></div>`,i.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/app-key",o.key),e.dataTransfer.effectAllowed="move",i.classList.add("ring-2","ring-white/30")}),i.addEventListener("dragend",()=>{i.classList.remove("ring-2","ring-white/30")}),i.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),i.addEventListener("drop",async e=>{e.preventDefault();const t=e.dataTransfer.getData("text/app-key"),n=i.dataset.key;if(!t||t===n)return;const a=u.apps.map(f=>f.key),s=a.indexOf(t),c=a.indexOf(n);if(s<0||c<0)return;const d=u.apps.splice(s,1)[0];u.apps.splice(c,0,d),ee(),await Gt(u.apps.map(f=>f.key))}),r.appendChild(i)}if(!localStorage.getItem("zm_dnd_hint")){const o=document.createElement("div");o.className="text-xs text-neutral-300 mt-2",o.textContent="Tip: Drag tiles to rearrange. Your layout is saved to your account.",r.parentElement.appendChild(o),localStorage.setItem("zm_dnd_hint","1")}}}async function Z(r){try{const o=await I(`/api/sab/queue?page=${r}`);u.sabPage=o.page,u.sabPages=o.pages||1;const i=l("#sabRows"),e=(o.slots||[]).map(c=>{const d=Math.max(0,Math.min(100,Number(c.percentage||0)));return`<tr class="border-t border-white/10"><td class="py-2 pr-2">${c.filename}</td><td>${c.status}</td><td class="w-56"><div class="relative bar h-5"><span style="width:${d}%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">${d}%</div></div></td><td class="text-right">${c.timeleft||""}</td></tr>`}).join("");i.innerHTML=e||'<tr class="border-t border-white/10"><td class="py-2 pr-2 text-neutral-300">–</td><td class="text-neutral-300">–</td><td class="w-56"><div class="relative bar h-5"><span style="width:0%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">0%</div></div></td><td class="text-right text-neutral-300">–</td></tr>';const t=o.speedText||(o.speed?o.speed>=1024?(o.speed/1024).toFixed(2)+" MB/s":o.speed.toFixed(0)+" KB/s":"0 KB/s");l("#sabStatus").textContent=`Speed: ${t}${o.paused?" (paused)":""}`;const n=l("#sabPage"),a=l("#sabPrev"),s=l("#sabNext");u.sabPages>1?(n.textContent=`Page ${u.sabPage} / ${u.sabPages}`,a.disabled=u.sabPage<=1,s.disabled=u.sabPage>=u.sabPages,a.classList.toggle("opacity-50",a.disabled),s.classList.toggle("opacity-50",s.disabled),n.parentElement.classList.remove("hidden")):n.parentElement.classList.add("hidden")}catch{l("#sabRows").innerHTML='<tr class="border-t border-white/10"><td class="py-2 pr-2 text-neutral-300">–</td><td class="text-neutral-300">–</td><td class="w-56"><div class="relative bar h-5"><span style="width:0%; border-radius:9999px;"></span><div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white drop-shadow">0%</div></div></td><td class="text-right text-neutral-300">–</td></tr>',l("#sabStatus").textContent="";const o=l("#sabPage")?.parentElement;o&&o.classList.add("hidden")}}function Zt(){clearInterval(u.sabTimer),(typeof u.sabPage!="number"||u.sabPage<1)&&(u.sabPage=1),Z(u.sabPage),u.sabTimer=setInterval(()=>Z(u.sabPage),3e3),l("#sabPrev").onclick=()=>{u.sabPage>1&&(u.sabPage--,Z(u.sabPage))},l("#sabNext").onclick=()=>{u.sabPages&&u.sabPage<u.sabPages&&(u.sabPage++,Z(u.sabPage))}}function Be(){return!u.me||u.me.role!=="admin"?!1:(u.me.preferences||{}).showNowPlaying!==!1}async function ft(){try{const r=await I("/api/now-playing"),o=Array.isArray(r)?r:r.sessions||[],i=l("#nowPlayingWrap"),e=l("#nowPlaying"),t=l("#npMeta");if(!Be()){i.classList.add("hidden");return}if(i.classList.remove("hidden"),window.__npSampledAt=Date.now(),t.textContent=o.length?`${o.length} active session${o.length>1?"s":""}`:"",!o.length){e.innerHTML='<div class="text-sm text-neutral-300">No one is watching right now.</div>';return}e.innerHTML=o.map(n=>{const a=typeof n.viewOffsetMs=="number"?n.viewOffsetMs:typeof n.viewOffset=="number"?n.viewOffset:null,s=typeof n.durationMs=="number"?n.durationMs:typeof n.duration=="number"?n.duration:null,c=a!=null?a/1e3:null,d=s!=null?s/1e3:null,f=c!=null&&d>0?Math.max(0,Math.min(100,c/d*100)):null,p=f??Math.max(0,Math.min(100,Number(n.progress||0))),m=n.user||"Unknown",g=n.title||"",N=n.quality?` • ${n.quality}`:"",B=n.state==="paused"?" (paused)":"",x=c!=null&&d>0?`${X(c)} / ${X(d)}`:`${p.toFixed(0)}%`;return`<div class="flex items-center justify-between py-2 border-t border-white/10" data-npid="${(n.id||g+m).toString().replace(/"/g,"")}" data-duration="${s||""}" data-offset="${a||""}" data-state="${n.state||""}"><div class="min-w-0 pr-4"><div class="font-semibold truncate">${m}${B}</div><div class="text-xs text-neutral-300 truncate">${g}${N}${n.device?` • ${n.device}`:""}</div></div><div class="w-56"><div class="relative bar h-4"><span style="width:${p}%"></span><div class="absolute inset-0 flex items-center justify-center text-[10px]" data-role="np-time">${x}</div></div></div></div>`}).join(""),Xt()}catch{const o=l("#nowPlayingWrap");Be()?(o.classList.remove("hidden"),l("#nowPlaying").innerHTML='<div class="text-sm text-red-300">Now Playing unavailable.</div>',l("#npMeta").textContent=""):o.classList.add("hidden")}}function Xt(){try{u.npClock&&clearInterval(u.npClock),u.npClock=setInterval(()=>{const r=window.__npSampledAt||Date.now(),o=Date.now()-r;document.querySelectorAll("#nowPlaying [data-duration]").forEach(i=>{const e=Number(i.getAttribute("data-duration")||0);let t=Number(i.getAttribute("data-offset")||0);const n=(i.getAttribute("data-state")||"").toLowerCase();if(!e||e<=0)return;n!=="paused"&&(t=t+o);const a=Math.max(0,Math.min(e,t))/1e3,s=e/1e3,c=Math.max(0,Math.min(100,a/s*100)),d=i.querySelector(".bar span");d&&(d.style.width=c+"%");const f=i.querySelector('[data-role="np-time"]');f&&(f.textContent=`${X(a)} / ${X(s)}`)})},1e3)}catch{}}function en(){if(clearInterval(u.npTimer),!Be()){l("#nowPlayingWrap").classList.add("hidden");return}ft(),u.npTimer=setInterval(ft,5e3)}function tn(){return!!(u.me&&u.me.totpSecret)}async function Me(){if(!l("#mfaBox"))return;const o=tn();l("#mfaStatus").textContent=o?"Enabled":"Disabled",l("#mfaStart").classList.toggle("hidden",o),l("#mfaDisable").classList.toggle("hidden",!o),l("#mfaSetup").classList.add("hidden"),l("#mfaStart").onclick=async()=>{try{const i=await I("/api/me",{method:"PUT",body:JSON.stringify({mfaAction:"start"})});if(i.otpauth){const e=i.secret||(()=>{try{const t=new URL(i.otpauth);return new URLSearchParams(t.search).get("secret")||""}catch{}return""})();l("#mfaSetup").classList.remove("hidden"),l("#mfaOtpauth").textContent=i.otpauth,l("#mfaSecret").textContent=e,l("#mfaCopyLink").onclick=()=>Y(i.otpauth),l("#mfaCopySecret").onclick=()=>Y(e);try{wt("#mfaQr",i.otpauth)}catch(t){console.error(t)}u.me=i.user||u.me}}catch(i){S(i.error||"Failed to start setup","err")}},l("#mfaDisable").onclick=async()=>{if(confirm("Disable authenticator app for this account?"))try{const i=await I("/api/me",{method:"PUT",body:JSON.stringify({mfaAction:"disable"})});u.me=i.user,S("MFA disabled"),Me()}catch(i){S(i.error||"Failed to disable","err")}},l("#mfaVerify").onclick=async()=>{const i=l("#mfaCode").value.trim();if(!/^[0-9]{6}$/.test(i)){S("Enter the 6‑digit code from your app","err");return}try{const e=await I("/api/me",{method:"PUT",body:JSON.stringify({mfaAction:"verify",code:i})});u.me=e.user,S("MFA enabled and saved"),Me()}catch(e){S(e.error||"Invalid or expired MFA code","err")}}}function nn(){const r=document.getElementById("meForm");if(!r||!u.me)return;r.username.value="",r.password.value="",r.firstName.value=u.me.firstName||"",r.lastName.value=u.me.lastName||"";const o=l("#prefTheme");o&&(o.value=u.me.preferences&&u.me.preferences.theme||"dark")}document.getElementById("meForm").addEventListener("submit",async r=>{r.preventDefault();const o=new FormData(r.target),i={username:o.get("username")||void 0,password:o.get("password")||void 0,firstName:(o.get("firstName")||"").trim(),lastName:(o.get("lastName")||"").trim()},e=Object.assign({},u.me.preferences||{}),t=l("#prefTheme");t&&(e.theme=t.value);const n=l("#prefShowNP");if(n&&u.me&&u.me.role==="admin"&&(e.showNowPlaying=!!n.checked),i.preferences=e,l("#pfp")&&l("#pfp").files[0]){const a=l("#pfp").files[0];i.profileImage=await new Promise((s,c)=>{const d=new FileReader;d.onload=()=>s(d.result),d.onerror=c,d.readAsDataURL(a)})}try{const a=await I("/api/me",{method:"PUT",body:JSON.stringify(i)});u.me=a.user,yt(),S("Saved.");const s=[u.me.firstName,u.me.lastName].filter(Boolean).join(" ")||u.me.username;l("#userName").textContent=s;const c=l("#userAvatar"),d=l("#userInitial");u.me.profileImage?(c.src=u.me.profileImage,c.classList.remove("hidden"),d.classList.add("hidden")):(d.textContent=bt(u.me),d.classList.remove("hidden"),c.classList.add("hidden"))}catch(a){S(a.error||"Save failed","err")}});l("#btn-admin-close").onclick=()=>D("#view-apps");l("#btn-settings-close").onclick=()=>D("#view-apps");document.getElementById("year").textContent=new Date().getFullYear();
